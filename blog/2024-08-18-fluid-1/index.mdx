---
authors: jerryi
enableComments: true
tags:
  - dynamics
  - visualization
---

# Real-time Fluid Simulation Part 1
*Using Wolfram Language and WLJS libraries*

In this notebook, we will explore a simple technique for simulating 2D incompressible fluids for visual effects. This work is mostly based on Jos Stam. Stable Fluids SIGGRAPH 1999 as well as a tutorial by [Karl Sims](https://www.karlsims.com/fluid-flow.html)

<!--truncate-->

import { WLJSHTML, WLJSEditor, WLJSStore } from "@site/src/components/wljs-reactcells";



<WLJSStore json={require('./attachments/36a310dd-d5f8-40a8-b29a-535bca60d052.txt').default} notebook={require('./attachments/notebook-36a.wln').default}/>



## Working with a Grid

Here we will use the Euler method to represent a fluid, i.e., by storing velocity as a vector field discretized to a uniform grid.

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"74a3a573-87d2-4324-a102-0d6df63439f5"} type={"Input"} opts={{"InitGroup":true}} >{`grid%20%3D%20Table%5BCross%5B%7Bi%2Cj%2C0%7D%2C%20%7B0%2C0%2C1%7D%5D%5B%5B%3B%3B2%5D%5D%2C%20%7Bi%2C%205%7D%2C%20%7Bj%2C%205%7D%5D%3B%0A%25%20%2F%2F%20MatrixForm%20`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"7df65f24-80c7-401a-bf50-62ecc4935496"} type={"Output"} opts={{}} >{`%28%28%2AGB%5B%2A%29%7B%7B%28%28%2AGB%5B%2A%29%7B%7B1%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-1%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B2%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-1%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B3%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-1%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B4%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-1%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B5%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-1%7D%7D%28%2A%5DGB%2A%29%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%28%2AGB%5B%2A%29%7B%7B1%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-2%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B2%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-2%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B3%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-2%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B4%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-2%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B5%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-2%7D%7D%28%2A%5DGB%2A%29%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%28%2AGB%5B%2A%29%7B%7B1%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-3%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B2%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-3%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B3%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-3%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B4%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-3%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B5%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-3%7D%7D%28%2A%5DGB%2A%29%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%28%2AGB%5B%2A%29%7B%7B1%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-4%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B2%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-4%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B3%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-4%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B4%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-4%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B5%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-4%7D%7D%28%2A%5DGB%2A%29%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%28%2AGB%5B%2A%29%7B%7B1%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-5%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B2%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-5%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B3%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-5%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B4%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-5%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B5%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B-5%7D%7D%28%2A%5DGB%2A%29%29%7D%7D%28%2A%5DGB%2A%29%29`}</WLJSEditor>

Then one can easily visualize it as a vector field:

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"57756056-7501-4d9e-8547-d6213e8d7732"} type={"Input"} opts={{}} >{`grid%20%2F%2F%20ListVectorPlot`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"22f5cba7-8553-4e89-84bc-6f72a9ea4887"} type={"Output"} opts={{}} >{`%28%2AVB%5B%2A%29%28FrontEndRef%5B%227fa3d105-973d-43df-aa2e-88d286b02c82%22%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRCeEJBwK8rPK3HNS3GtSE0uLUlMykkNVgEKm6clGqcYGpjqWpobp%2BiaGKek6SYmGqXqWlikGFmYJRkYJVsYAQCGjBWk%22%2A%29%28%2A%5DVB%2A%29`}</WLJSEditor>

For the best performance, we will use `Map` or `MapIndexed` with a pure function inside. Then Wolfram Kernel is able to use JIT compilation. For example:

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"8c3fa2b1-6b3e-4b1f-b192-63ab80b191bb"} type={"Input"} opts={{}} >{`Map%5BFunction%5Bvector%2C%20%28%28%2AGB%5B%2A%29%7B%7B0%28%2A%7C%2A%29%2C%28%2A%7C%2A%29-1%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B1%28%2A%7C%2A%29%2C%28%2A%7C%2A%290%7D%7D%28%2A%5DGB%2A%29%29%20.%20vector%5D%2C%20grid%2C%20%7B2%7D%5D%0AListVectorPlot%5B%25%5D`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"1a963ff2-bd9d-4e47-abb9-0944393b760c"} type={"Output"} opts={{}} >{`%7B%7B%7B1%2C1%7D%2C%7B1%2C2%7D%2C%7B1%2C3%7D%2C%7B1%2C4%7D%2C%7B1%2C5%7D%7D%2C%7B%7B2%2C1%7D%2C%7B2%2C2%7D%2C%7B2%2C3%7D%2C%7B2%2C4%7D%2C%7B2%2C5%7D%7D%2C%7B%7B3%2C1%7D%2C%7B3%2C2%7D%2C%7B3%2C3%7D%2C%7B3%2C4%7D%2C%7B3%2C5%7D%7D%2C%7B%7B4%2C1%7D%2C%7B4%2C2%7D%2C%7B4%2C3%7D%2C%7B4%2C4%7D%2C%7B4%2C5%7D%7D%2C%7B%7B5%2C1%7D%2C%7B5%2C2%7D%2C%7B5%2C3%7D%2C%7B5%2C4%7D%2C%7B5%2C5%7D%7D%7D`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"da1b74b7-1f22-41d7-8fda-91060b8e9e2c"} type={"Output"} opts={{}} >{`%28%2AVB%5B%2A%29%28FrontEndRef%5B%229d29d953-9bbb-46aa-805e-391ff5054311%22%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRCeEJBwK8rPK3HNS3GtSE0uLUlMykkNVgEKW6YYWaZYmhrrWiYlJemamCUm6loYmKbqGlsapqWZGpiaGBsaAgCEmxVJ%22%2A%29%28%2A%5DVB%2A%29`}</WLJSEditor>

### Custom Syntax Sugar

Another possibility to visualize using pure syntax sugar would be to define our own output form for a single velocity vector.

The most efficient way is to define a decorator function in Javascript. Let it be a small arrow pointing to a desired direction.

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"80d9ba13-b899-4f19-ae99-0ad772f0796e"} type={"Input"} opts={{"Fade":true}} >{`.js%0Acore.ArrowGuide%20%3D%20async%20%28args%2C%20env%29%20%3D%3E%20%7B%0A%20%20const%20dir%20%3D%20await%20interpretate%28args%5B0%5D%2C%20env%29%3B%0A%20%20const%20mag%20%3D%20dir.map%28%28el%29%3D%3Eel%2Ael%29.reduce%28%28c%2Ca%29%20%3D%3E%20c%2Ba%29%3B%0A%0A%20%20const%20angle%20%3D%20Math.round%28180%20%2A%20Math.atan2%28dir%5B0%5D%2C%20dir%5B1%5D%29%20%2F%20Math.PI%29%3B%0A%20%20%0A%20%20console.log%28angle%29%3B%0A%20%20env.element.style.transform%20%3D%20%60rotate%28%24%7Bangle%7Ddeg%29%60%3B%0A%20%20%0A%20%20if%20%28mag%20%3C%200.01%29%20%7B%20%2F%2Fdo%20not%20display%20if%20it%20is%20too%20small%0A%20%20%20%20env.element.style.opacity%20%3D%200.5%3B%0A%20%20%20%20env.element.innerHTML%20%3D%20%22.%22%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20env.element.innerHTML%20%3D%20%22%26uarr%3B%22%3B%0A%20%20%7D%0A%7D`}</WLJSEditor>

<WLJSEditor display={"js"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"096909ea-cc93-470d-b07f-f7e9d6b37ae5"} type={"Output"} opts={{}} >{`%0Acore.ArrowGuide%20%3D%20async%20%28args%2C%20env%29%20%3D%3E%20%7B%0A%20%20const%20dir%20%3D%20await%20interpretate%28args%5B0%5D%2C%20env%29%3B%0A%20%20const%20mag%20%3D%20dir.map%28%28el%29%3D%3Eel%2Ael%29.reduce%28%28c%2Ca%29%20%3D%3E%20c%2Ba%29%3B%0A%0A%20%20const%20angle%20%3D%20Math.round%28180%20%2A%20Math.atan2%28dir%5B0%5D%2C%20dir%5B1%5D%29%20%2F%20Math.PI%29%3B%0A%20%20%0A%20%20console.log%28angle%29%3B%0A%20%20env.element.style.transform%20%3D%20%60rotate%28%24%7Bangle%7Ddeg%29%60%3B%0A%20%20%0A%20%20if%20%28mag%20%3C%200.01%29%20%7B%20%2F%2Fdo%20not%20display%20if%20it%20is%20too%20small%0A%20%20%20%20env.element.style.opacity%20%3D%200.5%3B%0A%20%20%20%20env.element.innerHTML%20%3D%20%22.%22%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20env.element.innerHTML%20%3D%20%22%26uarr%3B%22%3B%0A%20%20%7D%0A%7D`}</WLJSEditor>

Now we define a standard form `ArrowGuide`, which will use the defined Javascript function to display itself inside a cell.

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"59ea3062-81d1-473d-bde4-14cde7a0f505"} type={"Input"} opts={{"InitGroup":true}} >{`ArrowGuide%20%2F%3A%20MakeBoxes%5Ba_ArrowGuide%2C%20StandardForm%5D%20%3A%3D%20%0A%20%20ViewBox%5Ba%2F%2FFirst%2C%20a%5D`}</WLJSEditor>

The first argument will be an actual expression used as input; `First` will break our wrapper and substitute an original vector.

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"c4478553-1bf2-4c62-84a6-76645f3b7636"} type={"Input"} opts={{}} >{`ArrowGuide%5B%7B1%2C1%7D%5D`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"1c68dc44-b6ee-460c-a102-f534482fd926"} type={"Output"} opts={{}} >{`%28%2AVB%5B%2A%29%28%7B1%2C%201%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBKkAEwCJmgvW%22%2A%29%28%2A%5DVB%2A%29`}</WLJSEditor>

Now one can do some cool tricks like this one:

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"e91e36d0-3637-4fed-9cbd-89f5b557d0e2"} type={"Input"} opts={{}} >{`%28%2AVB%5B%2A%29%28%7B1%2C%201%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBKkAEwCJmgvW%22%2A%29%28%2A%5DVB%2A%29%20.%20%28%2AVB%5B%2A%29%28%7B1%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBKnIBGIGAImWC9U%3D%22%2A%29%28%2A%5DVB%2A%29`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"0afb84e7-d747-475e-be77-ba2f0cbfaf8d"} type={"Output"} opts={{}} >{`1`}</WLJSEditor>

Now we can basically apply this decoration wrapper to our matrix using multidimensional `Map` function and then again output it as a matrix

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"9044ba17-5f74-43f4-8cd3-bc96fab48bbe"} type={"Input"} opts={{}} >{`Map%5BArrowGuide%2C%20grid%2C%20%7B2%7D%5D%20%2F%2F%20MatrixForm%20`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"f7433e0d-4054-4bfc-b7d1-bea9bf882c81"} type={"Output"} opts={{}} >{`%28%28%2AGB%5B%2A%29%7B%7B%28%2AVB%5B%2A%29%28%7B1%2C%20-1%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBKnI%2FA8EAJOMD9E%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B2%2C%20-1%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBPEy%2FwMBAJOVD9I%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B3%2C%20-1%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JZAYyMv8DAQCTng%2FT%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B4%2C%20-1%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBDEy%2FwMBAJOnD9Q%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B5%2C%20-1%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JZAUyMv8DAQCTsA%2FV%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B1%2C%20-2%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBKnI%2FPf%2F%2F38Ak4gP0A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B2%2C%20-2%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBPEy%2F%2F3%2F%2Fx8Ak5EP0Q%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B3%2C%20-2%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JZAYyMv%2F9%2F%2F8fAJOaD9I%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B4%2C%20-2%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBDEy%2F%2F3%2F%2Fx8Ak6MP0w%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B5%2C%20-2%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JZAUyMv%2F9%2F%2F8fAJOsD9Q%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B1%2C%20-3%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBKnI%2FPv%2F%2F38Ak4QPzw%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B2%2C%20-3%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBPEy%2F%2F7%2F%2Fx8Ak40P0A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B3%2C%20-3%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JZAYyMv%2F%2B%2F%2F8fAJOWD9E%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B4%2C%20-3%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBDEy%2F%2F7%2F%2Fx8Ak58P0g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B5%2C%20-3%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JZAUyMv%2F%2B%2F%2F8fAJOoD9M%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B1%2C%20-4%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBKnI%2FPP%2F%2F38Ak4APzg%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B2%2C%20-4%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBPEy%2F%2Fz%2F%2Fx8Ak4kPzw%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B3%2C%20-4%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JZAYyMv%2F8%2F%2F8fAJOSD9A%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B4%2C%20-4%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBDEy%2F%2Fz%2F%2Fx8Ak5sP0Q%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B5%2C%20-4%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JZAUyMv%2F8%2F%2F8fAJOkD9I%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B1%2C%20-5%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBKnI%2FP3%2F%2F38Ak3wPzQ%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B2%2C%20-5%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBPEyf%2F%2F%2F%2Fx8Ak4UPzg%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B3%2C%20-5%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JZAYyMn%2F%2F%2F%2F8fAJOOD88%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B4%2C%20-5%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBDEyf%2F%2F%2F%2Fx8Ak5cP0A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B5%2C%20-5%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JZAUyMn%2F%2F%2F%2F8fAJOgD9E%3D%22%2A%29%28%2A%5DVB%2A%29%7D%7D%28%2A%5DGB%2A%29%29`}</WLJSEditor>

Let's define a helper function

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"a0d0d26e-ccc3-49aa-8370-8595ac2b585b"} type={"Input"} opts={{"InitGroup":true}} >{`showAsMatrix%5Bl_%5D%20%3A%3D%20Map%5BArrowGuide%2C%20l%2C%20%7B2%7D%5D%20%2F%2F%20MatrixForm%20`}</WLJSEditor>

## Divergence
__Conservation of mass__ for incompressible fluid dictates

$$
div ~\mathbf{v} = 0
$$

where $\mathbf{v}$ is velocity vector field we played with earlier - `grid`.



### Example

Let us start with a simples example

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"ee7cc809-22c8-4a24-93e0-f8863aa9a58b"} type={"Input"} opts={{}} >{`grid%20%3D%20Table%5B%7B0%2C0%7D%2C%20%7Bi%2C5%7D%2C%20%7Bj%2C5%7D%5D%3B%0Agrid%20%2F%2F%20showAsMatrix`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"3f25d4fb-b61c-4860-8cf9-0c186e93041b"} type={"Output"} opts={{}} >{`%28%28%2AGB%5B%2A%29%7B%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%7D%28%2A%5DGB%2A%29%29`}</WLJSEditor>

And put a single vector in the middle

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"e0f50781-ab65-467e-986d-1ea1ea2b1e60"} type={"Input"} opts={{}} >{`grid%20%3D%20%28%28%2AGB%5B%2A%29%7B%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%201%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMmSBlAImRC9U%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%7D%28%2A%5DGB%2A%29%29%3B`}</WLJSEditor>

To visualize the divergence, one can use `DensityPlot`

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"d2858fc8-5802-4f49-9cd5-526d7c204439"} type={"Input"} opts={{}} >{`%7BintX%2C%20intY%7D%20%3D%20%7B%0A%20%20%20%20ListInterpolation%5Bgrid%5B%5BAll%2CAll%2C1%5D%5D%5D%2C%0A%20%20%20%20ListInterpolation%5Bgrid%5B%5BAll%2CAll%2C2%5D%5D%5D%0A%7D%3B%20%28%2ABB%5B%2A%29%28%2Ainterpolate%20data%20for%20the%20convenience%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%0ACoolColor%5B%20z_%20%5D%20%3A%3D%20RGBColor%5Bz%2C%200.5%2C%201%20-%20z%5D%3B%0A%0A%28%2ABB%5B%2A%29%28%2Afind%20divergence%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0ADiv%5B%7BintX%5Bx%2Cy%5D%2C%20intY%5Bx%2Cy%5D%7D%2C%20%7Bx%2Cy%7D%5D%3B%20%0AContourPlot%5B%25%2C%20%7Bx%2C1%2C5%7D%2C%20%7By%2C1%2C5%7D%2C%20ColorFunction-%3ECoolColor%5D`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"431e957f-5467-48d4-8ec6-0864d75e5d01"} type={"Output"} opts={{}} >{`%28%2AVB%5B%2A%29%28FrontEndRef%5B%2215f4029b-3d6d-46e2-8893-95deb4f9c83e%22%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRCeEJBwK8rPK3HNS3GtSE0uLUlMykkNVgEKG5qmmRgYWSbpGqeYpeiamKUa6VpYWBrrWpqmpCaZpFkmWxinAgB8URWN%22%2A%29%28%2A%5DVB%2A%29`}</WLJSEditor>

From a physical point of view, it means that there is a *source node* at the bottom and a *drain* at the top, which should not be a feature of a closed system with incompressible fluid.

### Removing the Divergence
One can try to solve this problem iteratively by taking a field with non-zero divergency and apply artificial tranformation on it to make it satisfy the equation.

There is a [clever algorithm](https://www.karlsims.com/fluid-flow.html) for removing the divergence of an arbitrary 2D vector field, which acts like a cellular automaton 

$$
\begin{align*}
v^\prime_{(x=0,y=0)} &= v_{(0,0)} + \frac{1}{8} \Big\{ \\ 
&\Big((v_{(-1,-1)} + v_{(1,1)})\cdot \begin{bmatrix}
   1  \\
   1
\end{bmatrix} \Big) \begin{bmatrix}
   1  \\
   1
\end{bmatrix} \Big\} + \\

&\Big((v_{(-1,1)} + v_{(1,-1)})\cdot \begin{bmatrix}
   1  \\
   -1
\end{bmatrix} \Big) \begin{bmatrix}
   1  \\
   -1
\end{bmatrix} \Big\} + \\

\begin{bmatrix}
   2 &  0\\
   0 & -2
\end{bmatrix} &\cdot (v_{(-1,0)} + v_{(1,0)} - v_{(0,-1)} - v_{(0,1)}) + \\

& (-4) v_{(0,0)} \Big\},

\end{align*}
$$

where $v^{\prime}_{(0,0)}$ is a new velocity vector at coordinates $(x,y)$ and others $v_{(i,j)}$ are ones from the previous state at $(x + i, y + j)$.


> This is done by adding flow away from high pressure converging areas, and toward low pressure diverging areas. 


Here is our implementation

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"a67839f1-1fe1-457e-a784-7f2234461627"} type={"Input"} opts={{"InitGroup":true}} >{`removeDivergence%5Bgrid_%5D%20%3A%3D%20With%5B%7B%0A%20%20%28%2ABB%5B%2A%29%28%2Asafety%20checks%2C%20which%20enforce%20closed%20boundaries%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20take%20%3D%20Function%5B%7Barray%2C%20x%2Cy%7D%2C%20If%5Bx%20%3E%3D%201%20%26%26%20x%20%3C%3D%20Length%5Bgrid%5D%20%26%26%20y%20%3E%3D%201%20%26%26%20y%20%3C%3D%20Length%5Bgrid%5D%2C%20array%5B%5Bx%2Cy%5D%5D%2C%20%7B0%2C0%7D%5D%5D%0A%7D%2C%0A%20%20MapIndexed%5BFunction%5B%7Bval%2C%20i%7D%2C%20%0A%20%20%20%20val%20%2B%20%28%2AFB%5B%2A%29%28%281%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%288.0%29%29%28%2A%5DFB%2A%29%20%28%0A%20%20%20%20%20%20%28%28take%5Bgrid%2C%20i%5B%5B1%5D%5D%20-%201%2C%20i%5B%5B2%5D%5D%20-%201%5D%20%2B%20take%5Bgrid%2C%20i%5B%5B1%5D%5D%20%2B%201%2C%20i%5B%5B2%5D%5D%20%2B%201%5D%29.%7B1%2C1%7D%29%7B1%2C1%7D%20%2B%0A%0A%20%20%20%20%20%20%28%28take%5Bgrid%2C%20i%5B%5B1%5D%5D%20-%201%2C%20i%5B%5B2%5D%5D%20%2B%201%5D%20%2B%20take%5Bgrid%2C%20i%5B%5B1%5D%5D%20%2B%201%2C%20i%5B%5B2%5D%5D%20-%201%5D%29.%7B1%2C-1%7D%29%7B1%2C-1%7D%20%2B%0A%0A%20%20%20%20%20%20%28take%5Bgrid%2C%20i%5B%5B1%5D%5D-1%2C%20i%5B%5B2%5D%5D%5D%20%2B%20take%5Bgrid%2C%20i%5B%5B1%5D%5D%2B1%2C%20i%5B%5B2%5D%5D%5D%20-%20take%5Bgrid%2C%20i%5B%5B1%5D%5D%2C%20i%5B%5B2%5D%5D-1%5D%20-%20take%5Bgrid%2C%20i%5B%5B1%5D%5D%2C%20i%5B%5B2%5D%5D%2B1%5D%29%7B2%2C-2%7D%20%2B%20take%5Bgrid%2C%20i%5B%5B1%5D%5D%2C%20i%5B%5B2%5D%5D%5D%20%28-4%29%0A%0A%20%20%20%20%29%0A%20%20%5D%2C%20grid%2C%20%7B2%7D%5D%0A%5D`}</WLJSEditor>

Let us test it.

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"5ef74ab6-6f2d-48d1-a7f3-0b90cd3c8088"} type={"Input"} opts={{}} >{`Table%5BNest%5BremoveDivergence%2C%20grid%2C%20i%5D%20%2F%2F%20showAsMatrix%2C%20%7Bi%2C%200%2C2%7D%5D%20%2F%2F%20Row%20`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"24dfce5d-2dc0-4d56-ba39-7e6a4fb41906"} type={"Output"} opts={{}} >{`%28%2AGB%5B%2A%29%7B%7B%28%28%2AGB%5B%2A%29%7B%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%201%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMmSBlAImRC9U%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0%2C%200%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC7JBNIMYAIAiY0L1A%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.125%2C%200.125%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYgCDA%2FZwBgDz8Q3k%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%20-0.25%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKOPCfgDp2w11%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B-0.125%2C%200.125%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYgCDA%2FthDHsA%2BPEOZA%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.25%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKOOCPQDpWwz1%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.5%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKOOBPQDpew0F%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.25%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKOOCPQDpWwz1%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B-0.125%2C%200.125%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYgCDA%2FthDHsA%2BPEOZA%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%20-0.25%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKOPCfgDp2w11%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.125%2C%200.125%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYgCDA%2FZwBgDz8Q3k%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACOAMA53wL5g%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%7D%28%2A%5DGB%2A%29%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%28%2AGB%5B%2A%29%7B%7B%28%2AVB%5B%2A%29%28%7B0.03125%2C%200.03125%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYgCDBfZwBgDyUQ2k%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%20-0.0625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKGPDfgDpmw1V%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.0625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKGODPQDpGwzV%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%20-0.0625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKGPDfgDpmw1V%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B-0.03125%2C%200.03125%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYgCDBfthDHsA91EOJA%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0.%2C%200.0625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKGODPQDpGwzV%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.125%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYgCDA%2FZQBgMDAPIyDOU%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%20-0.125%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKOPAfgDpuw1l%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B-0.125%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYgCDA%2FuhDAYGAPcyDWU%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.0625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKGODPQDpGwzV%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0.%2C%200.0625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKGODPQDpGwzV%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.125%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKOOAPQDpOwzl%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKOOJPQDpgw0J%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.125%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKOOAPQDpOwzl%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.0625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKGODPQDpGwzV%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B0.%2C%200.0625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKGODPQDpGwzV%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B-0.125%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYgCDA%2FuhDAYGAPcyDWU%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%20-0.125%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKOPAfgDpuw1l%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.125%2C%200.%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYgCDA%2FZQBgMDAPIyDOU%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.0625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKGODPQDpGwzV%22%2A%29%28%2A%5DVB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28%7B-0.03125%2C%200.03125%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYgCDBfthDHsA91EOJA%3D%3D%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%20-0.0625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKGPDfgDpmw1V%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%200.0625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKGODPQDpGwzV%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.%2C%20-0.0625%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYoACKGPDfgDpmw1V%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28%7B0.03125%2C%200.03125%7D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeF5BwLCrKL3cvzUxJTWOCqfDJLC4pYgCDBfZwBgDyUQ2k%22%2A%29%28%2A%5DVB%2A%29%7D%7D%28%2A%5DGB%2A%29%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7D%28%2A%5DGB%2A%29`}</WLJSEditor>

As you can see, if we have a stream of fluid from *A* to *B*, there must be some other streams made from *B* to *A*. The applied procedure produces the missing one spread over the whole grid if `removeDivergence` is applied multiple times.

We can check it directly by calculating the divergence.

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"6247d1de-940c-4a5c-8c06-e91a51ea94ed"} type={"Input"} opts={{"InitGroup":true}} >{`CoolColor%5B%20z_%20%5D%20%3A%3D%20RGBColor%5Bz%2C%200.5%2C%201%20-%20z%5D%3B%0A%0AplotDiv%5Bgrid_%5D%20%3A%3D%20Module%5B%7BintX%2C%20intY%2C%20x%2C%20y%7D%2C%0A%0A%20%20%7BintX%2C%20intY%7D%20%3D%20%7B%0A%20%20%20%20%20%20ListInterpolation%5Bgrid%5B%5BAll%2CAll%2C1%5D%5D%5D%2C%0A%20%20%20%20%20%20ListInterpolation%5Bgrid%5B%5BAll%2CAll%2C2%5D%5D%5D%0A%20%20%7D%3B%20%28%2ABB%5B%2A%29%28%2Ainterpolate%20data%20for%20the%20convenience%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%0A%20%20With%5B%7Bdiv%20%3D%20Div%5B%7BintX%5Bx%2Cy%5D%2C%20intY%5Bx%2Cy%5D%7D%2C%20%7Bx%2Cy%7D%5D%7D%2C%0A%20%20%20%20ContourPlot%5B%0A%20%20%20%20%20%20div%2C%20%7Bx%2C1%2C5%7D%2C%20%7By%2C1%2C5%7D%2C%20%0A%20%20%20%20%20%20ColorFunctionScaling%20-%3E%20False%2C%20%28%2ABB%5B%2A%29%28%2Amake%20sure%20to%20have%20the%20same%20scale%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20%20%20ColorFunction%20-%3E%20ColorData%5B%7B%22ThermometerColors%22%2C%20%7B-1%2C%201%7D%7D%5D%0A%20%20%20%20%5D%0A%20%20%5D%0A%5D%0A`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"58dd0876-f1d9-4c80-b84b-f2eca343ef62"} type={"Input"} opts={{}} >{`%7B%0A%20%20%7BStyle%5B%22Original%22%2C%2014%5D%2C%20plotDiv%5Bgrid%5D%7D%2C%20%0A%20%20%7BStyle%5B%228%20iterations%22%2C%2014%5D%2C%20plotDiv%5BNest%5BremoveDivergence%2C%20grid%2C%208%5D%5D%7D%0A%7D%20%2F%2F%20Transpose%20%2F%2F%20Grid%20`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"b91d8db9-983a-4416-8868-f5ba4373ec56"} type={"Output"} opts={{}} >{`%28%2AGB%5B%2A%29%7B%7B%28%2ABB%5B%2A%29%28%22Original%22%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNiYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCRYg4ZGfkwLhcQKJ4JKizLx0p%2FyKTD4gD6IdpCqoNCc1mA2uACwWUlSaCgCn0xcV%22%2A%29%28%2A%5DBB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2ABB%5B%2A%29%28%228%20iterations%22%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNiYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCRYg4ZGfkwLhcQKJ4JKizLx0p%2FyKTD4gD6IdpCqoNCc1mA2uACwWUlSaCgCn0xcV%22%2A%29%28%2A%5DBB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28FrontEndRef%5B%2262b4aa00-b857-4b7d-8530-a563afd164ec%22%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRCeEJBwK8rPK3HNS3GtSE0uLUlMykkNVgEKmxklmSQmGhjoJlmYmuuaJJmn6FqYGhvoJpqaGSempRiamaQmAwB%2FdRWX%22%2A%29%28%2A%5DVB%2A%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%29%28%2AVB%5B%2A%29%28FrontEndRef%5B%22b99a3f97-955e-4d38-b5cb-4ec0903c77e3%22%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRCeEJBwK8rPK3HNS3GtSE0uLUlMykkNVgEKJ1laJhqnWZrrWpqapuqapBhb6CaZJifpmqQmG1gaGCebm6caAwCG1hW5%22%2A%29%28%2A%5DVB%2A%29%7D%7D%28%2A%5DGB%2A%29`}</WLJSEditor>

Apart from obvious artifacts caused by interpolation on a small grid, this algorithm definitely works. However, it is still far from modeling a fluid.

### Interactive Example
We can try to solve this in real-time and see how it reacts live. However, the current approach to visualizing will be quite slow when it comes to dynamics.

If we just try to reevaluate `ListVectorPlot` directly, it will be horribly slow. In general, there is no need to reevaluate the whole expression for graphics. The grid is the same, but vectors differ. We can go either fully `raster` using `Image` or use SVG graphics. The latter is the easiest way. Let us start from the ground up.

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"94f9755f-043a-4720-b399-feb5cb3f1aa0"} type={"Input"} opts={{}} >{`grid%20%3D%20grid%20%2F%2F%20removeDivergence%3B%0A%0AGraphics%5B%7B%0A%20%20Table%5B%0A%20%20%20%20Arrow%5B%7B%0A%20%20%20%20%20%20%7Bi%2Cj%7D%2C%20%0A%20%20%20%20%20%20%7Bi%2Cj%7D%20%2B%201.5%20grid%5B%5Bi%5D%5D%5B%5Bj%5D%5D%0A%20%20%20%20%7D%5D%2C%20%7Bi%2C%205%7D%2C%20%7Bj%2C%205%7D%5D%0A%7D%2C%20PlotRange-%3E%7B%7B0%2C6%7D%2C%20%7B0%2C6%7D%7D%2C%20ImagePadding-%3ENone%5D`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"480fe257-f9b6-4a66-83e4-4badae70a6c7"} type={"Output"} opts={{}} >{`%28%2AVB%5B%2A%29%28FrontEndRef%5B%2246f8ea9d-0f01-4681-82d9-35d40f2fba91%22%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRCeEJBwK8rPK3HNS3GtSE0uLUlMykkNVgEKm5ilWaQmWqboGqQZGOqamFkY6loYpVjqGpummBikGaUlJVoaAgCBGxV6%22%2A%29%28%2A%5DVB%2A%29`}</WLJSEditor>

What about a color you ask. One can calculate `Hue` based on the polar angle of our vector

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"9159daef-55b8-451a-969e-b287e8fe3de9"} type={"Input"} opts={{}} >{`Graphics%5B%7B%0A%20%20Table%5B%7B%0A%20%20%20%20Hue%5B%28%2AFB%5B%2A%29%28%28%CF%80%20%2B%202%20ToPolarCoordinates%5Bgrid%5B%5Bi%5D%5D%5B%5Bj%5D%5D%5D%2F%2F%20Last%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%283%20%CF%80%29%29%28%2A%5DFB%2A%29%5D%2C%0A%20%20%20%20Arrow%5B%7B%0A%20%20%20%20%20%20%7Bi%2Cj%7D%2C%20%0A%20%20%20%20%20%20%7Bi%2Cj%7D%20%2B%201.5%20grid%5B%5Bi%5D%5D%5B%5Bj%5D%5D%0A%20%20%20%20%7D%5D%0A%20%20%7D%2C%20%7Bi%2C%205%7D%2C%20%7Bj%2C%205%7D%5D%0A%7D%2C%20PlotRange-%3E%7B%7B0%2C6%7D%2C%20%7B0%2C6%7D%7D%2C%20ImagePadding-%3ENone%5D`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"4a7933eb-e29e-49e3-8a8d-d9a9bc6cc3df"} type={"Output"} opts={{}} >{`%28%2AVB%5B%2A%29%28FrontEndRef%5B%225e1eca05-6839-466c-9b1d-9ac89c5ca036%22%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRCeEJBwK8rPK3HNS3GtSE0uLUlMykkNVgEKm6YapiYnGpjqmlkYW%2BqamJkl61omGaboWiYmW1gmmwKljM0AhKkVrA%3D%3D%22%2A%29%28%2A%5DVB%2A%29`}</WLJSEditor>

Now we basically recreated `VectorPlot` function in our primitive way. The next step will be to implement dynamic updates.

### Dynamic Evaluation
The key feature to fast dynamic evaluation is to minimize the amount of data transferred between the Kernel and frontend as well as the number of things updated.

We need to couple the `Arrow` primitive to a specific element of our array `grid`. To do this, one can use the `Offload` wrapper, which acts similarly to `Hold`

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"446f7d67-bb2e-49ab-aa0e-33a388ce5b95"} type={"Input"} opts={{}} >{`grid%20%3D%20Table%5B%7B0.%2C0.%7D%2C%20%7Bi%2C5%7D%2C%20%7Bj%2C5%7D%5D%3B%0Agrid%5B%5B3%2C3%5D%5D%20%3D%20%7B0%2C1.0%7D%3B%20%28%2ABB%5B%2A%29%28%2A%20initial%20divergence%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%0AGraphics%5B%7B%0A%20%20Table%5BWith%5B%7Bi%3Di%2C%20j%3Dj%7D%2C%20%28%2ABB%5B%2A%29%28%2A%20to%20substitute%20numbers%2C%20not%20symbols%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20Arrow%5B%7B%0A%20%20%20%20%20%20%7Bi%2Cj%7D%2C%20%0A%20%20%20%20%20%20%7Bi%2Cj%7D%20%2B%201.5%20grid%5B%5Bi%5D%5D%5B%5Bj%5D%5D%0A%20%20%20%20%7D%20%2F%2F%20Offload%20%5D%5D%2C%20%7Bi%2C%205%7D%2C%20%7Bj%2C%205%7D%5D%0A%7D%2C%20PlotRange-%3E%7B%7B0.5%2C5.5%7D%2C%20%7B0.5%2C5.5%7D%7D%2C%20ImagePadding-%3ENone%5D`}</WLJSEditor>

Now __try to evaluate the next cell__ multiple times.

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"487a6513-25cf-4a41-999f-d8ab268d8125"} type={"Input"} opts={{}} >{`grid%20%3D%20grid%20%2F%2F%20removeDivergence%3B`}</WLJSEditor>

Let us increase the resolution and automate the process using `AnimationFrameListener`. In general, one can also add dynamic color to our arrows as well.

---
**TL;DR**

<WLJSEditor display={"codemirror"} nid={"36a310dd-d5f8-40a8-b29a-535bca60d052"} id={"4d83b66d-cbd5-487f-a5f0-76cfd8f8a112"} type={"Input"} opts={{}} >{`bgrid%20%3D%20Table%5B%7B0.%2C0.%7D%2C%20%7Bi%2C15%7D%2C%20%7Bj%2C15%7D%5D%3B%0Abcolors%20%3D%20Table%5B1.0%2C%20%7BLength%5Bbgrid%5D%7D%2C%20%7BLength%5Bbgrid%5D%7D%5D%3B%0Abfps%20%3D%200%3B%0A%0AmouseHandler%5Bbgrid_%2C%20win_%2C%20canvas_%5D%20%3D%20Module%5B%7B%0A%20%20arrow%20%3D%20False%2C%0A%20%20dest%20%3D%20%7B0%2C0%7D%2C%0A%20%20start%20%3D%20%7B0%2C0%7D%0A%7D%2C%20%7B%0A%20%20%20%20%20%20%22mouseup%22%20-%3E%20Function%5Bxy%2C%0A%20%20%20%20%20%20%20%20With%5B%7Bv%20%3D%20-Normalize%5Bstart%20-%20xy%5D%7D%2C%0A%20%20%20%20%20%20%20%20%20%20Do%5B%20%0A%20%20%20%20%20%20%20%20%20%20%20%20With%5B%7Bp%20%3D%20Clip%5B%23%2C%20%7B1%2C15%7D%5D%20%26%2F%40%20Round%20%2F%40%20%28%28xy%20-%20start%29%20a%20%2B%20start%29%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20bgrid%5B%5Bp%5B%5B1%5D%5D%2Cp%5B%5B2%5D%5D%5D%5D%20%3D%20%7Bv%5B%5B1%5D%5D%2C%20v%5B%5B2%5D%5D%7D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%2C%20%7Ba%2C%200%2C%201%2C0.1%7D%5D%3B%20%28%2A%20a%20very%20stipid%20way%20of%20drawing%20lines%20%2A%29%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%5D%3B%0A%0A%20%20%20%20%20%20%20%20Delete%5Barrow%5D%3B%20%0A%20%20%20%20%20%20%20%20arrow%20%3D%20False%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%5D%2C%0A%0A%20%20%20%20%20%20%22mousemove%22%20-%3E%20Function%5Bxy%2C%0A%20%20%20%20%20%20%20%20dest%20%3D%20xy%3B%0A%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%0A%20%20%20%20%20%20%22mousedown%22%20-%3E%20Function%5Bxy%2C%0A%20%20%20%20%20%20%20%20start%20%3D%20xy%3B%0A%20%20%20%20%20%20%20%20dest%20%3D%20xy%20%2B%20%7B1%2C1%7D%3B%20%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20If%5Barrow%20%3D%21%3D%20False%2C%20Delete%5Barrow%5D%5D%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20arrow%20%3D%20FrontSubmit%5B%7B%0A%20%20%20%20%20%20%20%20%20%20AbsoluteThickness%5B3%5D%2C%20Gray%2C%20%0A%20%20%20%20%20%20%20%20%20%20Arrow%5B%7Bxy%2C%20dest%20%2F%2F%20Offload%7D%5D%0A%20%20%20%20%20%20%20%20%7D%2C%20%0A%20%20%20%20%20%20%20%20%20%20canvas%2C%20%0A%20%20%20%20%20%20%20%20%20%20%22Window%22-%3Ewin%2C%20%0A%20%20%20%20%20%20%20%20%20%20%22Tracking%22-%3ETrue%20%0A%20%20%20%20%20%20%20%20%5D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%5D%0A%20%20%7D%5D%3B%0A%0ASetAttributes%5BmouseHandler%2C%20HoldFirst%5D%0A%0A%28%2ABB%5B%2A%29%28%2Adefine%20handler%20for%20the%20animation%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0Abtime%20%3D%20AbsoluteTime%5B%5D%3B%0A%0AEventHandler%5B%22bframe%22%2C%20Function%5BNull%2C%0A%20%20bgrid%20%3D%20removeDivergence%5Bbgrid%5D%20%2F%2F%20N%3B%0A%20%20bcolors%20%3D%20Map%5BFunction%5Bval%2C%20%28%2AFB%5B%2A%29%28%28%CF%80%20%2B%202.0%20ToPolarCoordinates%5Bval%5D%2F%2F%20Last%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%283.0%20%CF%80%29%29%28%2A%5DFB%2A%29%20%5D%2C%20bgrid%2C%20%7B2%7D%5D%3B%0A%20%20%0A%20%20bfps%20%3D%20%28%2AFB%5B%2A%29%28%28%28bfps%20%2B%201%20%2F%20%28AbsoluteTime%5B%5D%20-%20btime%29%29%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29%20%2F%2F%20Round%3B%0A%20%20btime%20%3D%20AbsoluteTime%5B%5D%3B%20%0A%5D%5D%3B%0A%0A%0AWith%5B%7B%0A%20%20win%20%3D%20CurrentWindow%5B%5D%2C%20%28%2ABB%5B%2A%29%28%2A%20save%20the%20current%20window%20to%20append%20graphics%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20currentCell%20%3D%20ResultCell%5B%5D%2C%0A%20%20canvasId%20%3D%20CreateUUID%5B%5D%0A%7D%2C%0A%0A%20%20EventHandler%5Bwin%2C%20%7B%22Closed%22%20-%3E%20Function%5BNull%2C%0A%20%20%20%20Delete%5BcurrentCell%5D%20%28%2ABB%5B%2A%29%28%2A%20remove%20output%20cell%20if%20a%20notebook%20has%20been%20closed%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20%28%2ABB%5B%2A%29%28%2A%20this%20will%20prevent%20the%20animation%20running%20uncontrollably%20on%20the%20next%20start%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%5D%7D%5D%3B%0A%0A%20%20Graphics%5B%7B%0A%20%20%20%20Table%5BWith%5B%7Bi%3Di%2C%20j%3Dj%7D%2C%20%0A%20%20%20%20%20%20%28%2ABB%5B%2A%29%28%2A%20now%20we%20have%20dynamic%20Hue%20and%20dynamic%20Arrow%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20%20%20Offload%5B%7B%20%0A%20%20%20%20%20%20%20%20Hue%5Bbcolors%5B%5Bi%5D%5D%5B%5Bj%5D%5D%5D%2C%0A%20%20%20%20%20%20%20%20Arrow%5B%7B%7Bi%2Cj%7D%2C%20%7Bi%2Cj%7D%20%2B%20%20bgrid%5B%5Bi%5D%5D%5B%5Bj%5D%5D%7D%5D%0A%20%20%20%20%20%20%7D%5D%20%0A%20%20%20%20%0A%20%20%20%20%5D%2C%20%7Bi%2C15%7D%2C%20%7Bj%2C15%7D%5D%2C%0A%0A%20%20%20%20EventHandler%5BGraphics%60Canvas%5B%5D%2C%20mouseHandler%5Bbgrid%2C%20win%2C%20MetaMarker%5BcanvasId%5D%5D%5D%2C%20%0A%0A%20%20%20%20%28%2ABB%5B%2A%29%28%2Async%20with%20browser%27s%20repaint%20cycle%20and%20update%20of%20fps%20label%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20AnimationFrameListener%5Bbfps%20%2F%2F%20Offload%2C%20%22Event%22-%3E%22bframe%22%5D%2C%20%0A%20%20%20%20%28%2ABB%5B%2A%29%28%2Amark%20this%20instance%20of%20Graphics%20with%20uid%20to%20append%20new%20elements%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20MetaMarker%5BcanvasId%5D%2C%20%0A%20%20%20%20Text%5Bbfps%20%2F%2F%20Offload%2C%20%7B0%2C0%7D%5D%0A%20%20%7D%2C%20%0A%20%20%20%20Controls-%3EFalse%2C%20%0A%20%20%20%20ImageSize-%3E500%2C%20%0A%20%20%20%20PlotRange-%3E%7B%7B-0.5%2C15.5%7D%2C%20%7B-0.5%2C15.5%7D%7D%2C%20%0A%20%20%20%20ImagePadding-%3ENone%2C%20%0A%20%20%20%20TransitionType-%3ENone%0A%20%20%5D%0A%5D%0A`}</WLJSEditor>

The code can be divided into two parts: *visualization using Graphics and Arrow* and *calculation loop*.

As we discussed before, we draw each point from a grid individually with a pair of `Hue` and `Arrow`. At the same place, we attach listeners to the `Graphics` canvas to capture mouse clicks and movements to modify the velocity field.

Animation is done using `AnimationFrameListener` coupled to `fpsLabel`, which works as a trigger to a new frame. It serves two goals:
1. Sync animation with the browser's repaint cycle.
2. Do not start a new frame until the data is ready, which is indicated by `fpsLabel`. It can also be `grid`, but since `fpsLabel` is the last symbol to be updated before a new frame, we have chosen it to be a trigger.

Then, before a new frame, it fires an event object with `"bframe"` uid, which is captured later by `EventHandler`. In the animation loop, it removes divergence, recalculates colors, and then also updates the FPS counter just for the statistics.

An expected result is shown on a GIF below 


import testVideo from './attachments/testVideo.mov';

<video width={"100%"} controls>
  <source src={testVideo}/>
</video>

It is quite far from an actual fluid simulation. We should also consider the momentum of it.

__See you in Part 2__ 