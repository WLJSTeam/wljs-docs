---
authors: jerryi
tags:
  - graphics
  - animation
enableComments: true
---

# Real-time Fluid Simulation Part 3
*Using Wolfram Language and WLJS*

In this notebook we will apply some optimizations to the code, expand the resolution and switch to immediate mode of graphics rendering. 

<!--truncate-->

import { WLJSHTML, WLJSEditor, WLJSStore } from "@site/src/components/wljs-reactcells";



<WLJSStore json={require('./attachments/73fe49db-9a23-480c-b68c-e4e3334021f7.txt').default} notebook={require('./attachments/notebook-73f.wln').default}/>




## Measure and optimize ‚è±Ô∏è
Let us try to estimate the time we need to do our normal calculations on *divergence*, *advection* and *bilinear interpolation*

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"3778f713-f0ac-4279-af40-99061d14cf32"} type={"Input"} opts={{"Fade":true}} >{`ClearAll%5Badvect%5D%3B%20ClearAll%5BremoveDivergence%5D%3B%20ClearAll%5BbilinearInterpolation%5D%3B%0A%0Aadvect%5Bv_%2C%20u_%2C%20%CE%B4t_%3A0.1%5D%20%3A%3D%20With%5B%7Bmax%20%3D%20Length%5Bv%5D%7D%2C%20With%5B%7B%0A%20%20take%20%3D%20Function%5B%7Barray%2C%20x%2Cy%7D%2C%20If%5Bx%20%3E%3D%201%20%26%26%20x%20%3C%3D%20max%20%26%26%20y%20%3E%3D%201%20%26%26%20y%20%3C%3D%20max%2C%20array%5B%5Bx%2Cy%5D%5D%2C%20array%5B%5B1%2C1%5D%5D%200.%5D%5D%0A%7D%2C%0A%20%20Table%5B%20%0A%20%20%0A%20%20%20%20With%5B%7B%0A%20%20%20%20%20%20v1%20%3D%20%20%28%2AFB%5B%2A%29%28%28take%5Bv%2C%20i-1%2C%20j%5D%20%2B%20take%5Bv%2C%20i%2C%20j%5D%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29.%7B1%2C0%7D%2C%0A%20%20%20%20%20%20v2%20%3D%20%20%28%2AFB%5B%2A%29%28%28take%5Bv%2C%20i%2C%20j%2B1%5D%20%2B%20take%5Bv%2C%20i%2C%20j%5D%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29.%7B0%2C-1%7D%2C%0A%20%20%20%20%20%20v3%20%3D%20%20%28%2AFB%5B%2A%29%28%28take%5Bv%2C%20i%2B1%2C%20j%5D%20%2B%20take%5Bv%2C%20i%2C%20j%5D%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29.%7B-1%2C0%7D%2C%0A%20%20%20%20%20%20v4%20%3D%20%20%28%2AFB%5B%2A%29%28%28take%5Bv%2C%20i%2C%20j-1%5D%20%2B%20take%5Bv%2C%20i%2C%20j%5D%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29.%7B0%2C1%7D%2C%0A%20%20%20%20%20%20org%20%3D%20u%5B%5Bi%2Cj%5D%5D%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20%20%20org%20%2B%20%28%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20v1%20%28%2ATB%5B%2A%29Piecewise%5B%7B%7B%28%2A%7C%2A%29take%5Bu%2C%20i-1%2C%20j%5D%28%2A%7C%2A%29%2C%28%2A%7C%2A%29v1%20%3E%200%28%2A%7C%2A%29%7D%2C%7B%28%2A%7C%2A%29org%28%2A%7C%2A%29%2C%28%2A%7C%2A%29True%28%2A%7C%2A%29%7D%7D%5D%28%2A%7C%2A%29%28%2A1%3AeJxTTMoPSmNkYGAo5gESAZmpyanlmcWpTvkVmUxAAQBzVQdd%2A%29%28%2A%5DTB%2A%29%20%2B%20v3%20%28%2ATB%5B%2A%29Piecewise%5B%7B%7B%28%2A%7C%2A%29take%5Bu%2C%20i%2B1%2C%20j%5D%28%2A%7C%2A%29%2C%28%2A%7C%2A%29v3%20%3E%200%28%2A%7C%2A%29%7D%2C%7B%28%2A%7C%2A%29org%28%2A%7C%2A%29%2C%28%2A%7C%2A%29True%28%2A%7C%2A%29%7D%7D%5D%28%2A%7C%2A%29%28%2A1%3AeJxTTMoPSmNkYGAo5gESAZmpyanlmcWpTvkVmUxAAQBzVQdd%2A%29%28%2A%5DTB%2A%29%20%20%2B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20v4%20%28%2ATB%5B%2A%29Piecewise%5B%7B%7B%28%2A%7C%2A%29take%5Bu%2C%20i%2C%20j-1%5D%28%2A%7C%2A%29%2C%28%2A%7C%2A%29v4%20%3E%200%28%2A%7C%2A%29%7D%2C%7B%28%2A%7C%2A%29org%28%2A%7C%2A%29%2C%28%2A%7C%2A%29True%28%2A%7C%2A%29%7D%7D%5D%28%2A%7C%2A%29%28%2A1%3AeJxTTMoPSmNkYGAo5gESAZmpyanlmcWpTvkVmUxAAQBzVQdd%2A%29%28%2A%5DTB%2A%29%20%2B%20v2%20%28%2ATB%5B%2A%29Piecewise%5B%7B%7B%28%2A%7C%2A%29take%5Bu%2C%20i%2C%20j%2B1%5D%28%2A%7C%2A%29%2C%28%2A%7C%2A%29v2%20%3E%200%28%2A%7C%2A%29%7D%2C%7B%28%2A%7C%2A%29org%28%2A%7C%2A%29%2C%28%2A%7C%2A%29True%28%2A%7C%2A%29%7D%7D%5D%28%2A%7C%2A%29%28%2A1%3AeJxTTMoPSmNkYGAo5gESAZmpyanlmcWpTvkVmUxAAQBzVQdd%2A%29%28%2A%5DTB%2A%29%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%29%20%CE%B4t%0A%20%20%20%20%5D%0A%20%20%20%20%0A%20%20%2C%20%7Bi%2C%20max%7D%2C%20%7Bj%2C%20max%7D%5D%20%2F%2F%20Chop%0A%20%5D%5D%0A%0A%20removeDivergence%5Bgrid_%5D%20%3A%3D%20With%5B%7B%0A%20%20%28%2ABB%5B%2A%29%28%2Asafety%20checks%2C%20which%20enforce%20closed%20boundaries%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20take%20%3D%20Function%5B%7Barray%2C%20x%2Cy%7D%2C%20If%5Bx%20%3E%3D%201%20%26%26%20x%20%3C%3D%20Length%5Bgrid%5D%20%26%26%20y%20%3E%3D%201%20%26%26%20y%20%3C%3D%20Length%5Bgrid%5D%2C%20array%5B%5Bx%2Cy%5D%5D%2C%20%7B0%2C0%7D%5D%5D%0A%7D%2C%0A%20%20MapIndexed%5BFunction%5B%7Bval%2C%20i%7D%2C%20%0A%20%20%20%20val%20%2B%20%28%2AFB%5B%2A%29%28%281%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%288.0%29%29%28%2A%5DFB%2A%29%20%28%0A%20%20%20%20%20%20%28%28take%5Bgrid%2C%20i%5B%5B1%5D%5D%20-%201%2C%20i%5B%5B2%5D%5D%20-%201%5D%20%2B%20take%5Bgrid%2C%20i%5B%5B1%5D%5D%20%2B%201%2C%20i%5B%5B2%5D%5D%20%2B%201%5D%29.%7B1%2C1%7D%29%7B1%2C1%7D%20%2B%0A%0A%20%20%20%20%20%20%28%28take%5Bgrid%2C%20i%5B%5B1%5D%5D%20-%201%2C%20i%5B%5B2%5D%5D%20%2B%201%5D%20%2B%20take%5Bgrid%2C%20i%5B%5B1%5D%5D%20%2B%201%2C%20i%5B%5B2%5D%5D%20-%201%5D%29.%7B1%2C-1%7D%29%7B1%2C-1%7D%20%2B%0A%0A%20%20%20%20%20%20%28take%5Bgrid%2C%20i%5B%5B1%5D%5D-1%2C%20i%5B%5B2%5D%5D%5D%20%2B%20take%5Bgrid%2C%20i%5B%5B1%5D%5D%2B1%2C%20i%5B%5B2%5D%5D%5D%20-%20take%5Bgrid%2C%20i%5B%5B1%5D%5D%2C%20i%5B%5B2%5D%5D-1%5D%20-%20take%5Bgrid%2C%20i%5B%5B1%5D%5D%2C%20i%5B%5B2%5D%5D%2B1%5D%29%7B2%2C-2%7D%20%2B%20take%5Bgrid%2C%20i%5B%5B1%5D%5D%2C%20i%5B%5B2%5D%5D%5D%20%28-4%29%0A%0A%20%20%20%20%29%0A%20%20%5D%2C%20grid%2C%20%7B2%7D%5D%0A%5D%0A%0AbilinearInterpolation%5Barray_%2C%20%7Bx0_%2C%20y0_%7D%5D%20%3A%3D%20Module%5B%0A%20%20%7Brows%2C%20cols%2C%20x%20%3D%20y0%2C%20y%20%3D%20x0%2C%20x1%2C%20x2%2C%20y1%2C%20y2%2C%20fQ11%2C%20fQ12%2C%20fQ21%2C%20fQ22%7D%2C%0A%20%20%0A%20%20%28%2A%20Get%20the%20dimensions%20of%20the%20array%20%2A%29%0A%20%20%7Brows%2C%20cols%7D%20%3D%20Take%5BDimensions%5Barray%5D%2C%202%5D%3B%0A%20%20%0A%20%20%28%2A%20Clip%20points%20to%20the%20boundaries%20%2A%29%0A%20%20x%20%3D%20Clip%5Bx%2C%20%7B1%2C%20cols%7D%5D%3B%0A%20%20y%20%3D%20Clip%5By%2C%20%7B1%2C%20rows%7D%5D%3B%0A%20%20%0A%20%20%28%2A%20Find%20the%20bounding%20indices%20%2A%29%0A%20%20x1%20%3D%20Floor%5Bx%5D%3B%20%0A%20%20x2%20%3D%20Ceiling%5Bx%5D%3B%0A%20%20y1%20%3D%20Floor%5By%5D%3B%20%0A%20%20y2%20%3D%20Ceiling%5By%5D%3B%0A%20%20%0A%20%20%28%2A%20Get%20the%20values%20at%20the%20four%20corners%20%2A%29%0A%20%20fQ11%20%3D%20array%5B%5By1%2C%20x1%5D%5D%3B%0A%20%20fQ12%20%3D%20array%5B%5By2%2C%20x1%5D%5D%3B%0A%20%20fQ21%20%3D%20array%5B%5By1%2C%20x2%5D%5D%3B%0A%20%20fQ22%20%3D%20array%5B%5By2%2C%20x2%5D%5D%3B%0A%20%20%0A%20%20%28%2A%20Perform%20bilinear%20interpolation%20%2A%29%0A%20%20If%5Bx2%20%3D%3D%20x1%2C%0A%20%20%20%20If%5By2%20%3D%3D%20y1%2C%0A%20%20%20%20%20%20fQ11%2C%0A%20%20%20%20%20%201%2F%282%20%28y2%20-%20y1%29%29%20%2A%20%28%0A%20%20%20%20%20%20%20%20fQ11%20%28y2%20-%20y%29%20%2B%0A%20%20%20%20%20%20%20%20fQ21%20%28y2%20-%20y%29%20%2B%0A%20%20%20%20%20%20%20%20fQ12%20%28y%20-%20y1%29%20%2B%0A%20%20%20%20%20%20%20%20fQ22%20%28y%20-%20y1%29%0A%20%20%20%20%20%20%29%0A%20%20%20%20%5D%2C%0A%20%20%20%20If%5By2%20%3D%3D%20y1%2C%0A%20%20%20%20%20%201%2F%282%20%28x2%20-%20x1%29%29%20%2A%20%28%0A%20%20%20%20%20%20%20%20fQ11%20%28x2%20-%20x%29%20%2B%0A%20%20%20%20%20%20%20%20fQ21%20%28x%20-%20x1%29%20%2B%0A%20%20%20%20%20%20%20%20fQ12%20%28x2%20-%20x%29%20%2B%0A%20%20%20%20%20%20%20%20fQ22%20%28x%20-%20x1%29%0A%20%20%20%20%20%20%29%2C%0A%20%20%20%20%20%201%2F%28%28x2%20-%20x1%29%20%28y2%20-%20y1%29%29%20%2A%20%28%0A%20%20%20%20%20%20%20%20fQ11%20%28x2%20-%20x%29%20%28y2%20-%20y%29%20%2B%0A%20%20%20%20%20%20%20%20fQ21%20%28x%20-%20x1%29%20%28y2%20-%20y%29%20%2B%0A%20%20%20%20%20%20%20%20fQ12%20%28x2%20-%20x%29%20%28y%20-%20y1%29%20%2B%0A%20%20%20%20%20%20%20%20fQ22%20%28x%20-%20x1%29%20%28y%20-%20y1%29%0A%20%20%20%20%20%20%29%0A%20%20%20%20%5D%0A%20%20%5D%0A%5D%0A%0AadvectParticles%5Bv_%2C%20pts_%2C%20%CE%B4t_%3A0.02%5D%20%3A%3D%20Map%5BFunction%5Bp%2C%20p%20%2B%20%CE%B4t%20%28bilinearInterpolation%5Bv%2C%20p%5D%29%5D%2C%20pts%5D`}</WLJSEditor>

For a single run we have

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"4aac5186-935d-4ad1-a8f6-18284ad46ac1"} type={"Input"} opts={{"Fade":true}} >{`runTest%5Btitle_%5D%20%3A%3D%20With%5B%7B%7D%2C%0A%20%20testGrid%20%3D%20Table%5B%7B0.%2C0.%7D%2C%20%7Bi%2C15%7D%2C%20%7Bj%2C15%7D%5D%3B%0A%20%20testParticles%20%3D%20Table%5BRandomReal%5B%7B1%2C15%7D%2C%202%5D%2C%20%7Bi%2C1000%7D%5D%3B%0A%0A%20%20timing%20%3D%20%7B0.%2C%200.%2C%200.%7D%3B%0A%0A%20%20timing%5B%5B1%5D%5D%20%3D%20-AbsoluteTime%5B%5D%3B%0A%20%20testGrid%20%3D%20advect%5BtestGrid%2C%20testGrid%2C%200.2%5D%3B%0A%20%20timing%5B%5B1%5D%5D%20%2B%3D%20AbsoluteTime%5B%5D%3B%0A%0A%20%20timing%5B%5B2%5D%5D%20%3D%20-AbsoluteTime%5B%5D%3B%0A%20%20testGrid%20%3D%20removeDivergence%5BtestGrid%5D%3B%0A%20%20timing%5B%5B2%5D%5D%20%2B%3D%20AbsoluteTime%5B%5D%3B%0A%0A%20%20timing%5B%5B3%5D%5D%20%3D%20-AbsoluteTime%5B%5D%3B%0A%20%20testParticles%20%3D%20advectParticles%5BtestGrid%2C%20testParticles%2C%200.2%5D%3B%0A%20%20timing%5B%5B3%5D%5D%20%2B%3D%20AbsoluteTime%5B%5D%3B%0A%0A%20%20%7B%0A%20%20%20%20Style%5Btitle%2C%20Italic%2C%2012%5D%2C%0A%0A%20%20%20%20Flatten%20%2F%40%20%7B%0A%20%20%20%20%20%20%7BStyle%5B%22time%2C%20s%22%2C%20Italic%5D%2C%20Round%5Btiming%2C%200.001%5D%7D%2C%0A%20%20%20%20%20%20%7BStyle%5B%22Max%20FPS%22%2C%20Italic%5D%2C%20Round%5B1%20%2F%20%28timing%20%2F%2F%20Total%29%2C%201%5D%7D%0A%20%20%20%20%7D%20%2F%2F%20TableView%20%0A%20%20%7D%20%2F%2F%20Column%0A%5D%3B%0A%0ArunTest%5B%22Uncompiled%22%5D`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"fb3892d8-c313-401d-88d4-9156b13de3bf"} type={"Output"} opts={{}} >{`%28%2AGB%5B%2A%29%7B%7B%28%2ABB%5B%2A%29%28%22Uncompiled%22%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNiYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCRYg4ZGfkwJRxgkkgkuKMvPSnfIritmAPM%2BSxJzM5EweIBOiBKQhqDQnNZgNrhYsFlJUmgoAykcZ4w%3D%3D%22%2A%29%28%2A%5DBB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28FrontEndRef%5B%22bc61c228-82bc-43b5-a78b-b2829082984b%22%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRCeEJBwK8rPK3HNS3GtSE0uLUlMykkNVgEKJyWbGSYbGVnoWhglJeuaGCeZ6iaaWyTpJhlZGFkaALGFSRIAgx0VRQ%3D%3D%22%2A%29%28%2A%5DVB%2A%29%7D%7D%28%2A%5DGB%2A%29`}</WLJSEditor>

### Compile
Most probably for pure function JIT compiler should kick in, however, not all expressions are compilable in our case. We can make them by removing function declaration within the `Module` and replacing `Piecewise` with just a normal `If` statement.

It makes our code looks less readable ~~and removes all magic of WL~~, but the result worth it

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"5d76df8d-c1e8-4454-86a2-a735271062f8"} type={"Input"} opts={{"Fade":true}} >{`advect%20%3D%20Compile%5B%7B%7Bv%2C%20_Real%2C%203%7D%2C%20%7Bu%2C%20_Real%2C%203%7D%2C%20%7B%CE%B4t%2C%20_Real%2C%200%7D%7D%20%2C%20With%5B%7Bmax%20%3D%20Length%5Bv%5D%7D%2C%20With%5B%7B%0A%20%0A%7D%2C%0A%20%20Table%5B%20%0A%20%20%0A%20%20%20%20With%5B%7B%0A%20%20%20%20%20%20%28%2ABB%5B%2A%29%28%2A%20here%20we%20add%20a%20lot%20of%20manual%20check%20for%20boundary%20condition%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20%20%20v1%20%3D%20%28%2ABB%5B%2A%29%28%20%28%2AFB%5B%2A%29%28%28If%5Bi-1%20%3E%3D%201%2C%20v%5B%5Bi-1%2C%20j%5D%5D%2C%20%7B0.%2C0.%7D%5D%20%2B%20v%5B%5Bi%2C%20j%5D%5D%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeB5AILqnMSXXKr0hjgskHleakFnMBGU6JydnpRfmleSlpzDDlQe5Ozvk5%2BUVFDGDwwR6dwcAAAAHdFiw%3D%22%2A%29%28%2A%5DBB%2A%29.%7B1%2C0%7D%2C%0A%20%20%20%20%20%20v2%20%3D%20%20%28%2AFB%5B%2A%29%28%28If%5Bj%2B1%20%3C%3D%20max%2C%20v%5B%5Bi%2C%20j%2B1%5D%5D%2C%20%7B0.%2C0.%7D%5D%20%2B%20v%5B%5Bi%2C%20j%5D%5D%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29.%7B0%2C-1%7D%2C%0A%20%20%20%20%20%20v3%20%3D%20%20%28%2AFB%5B%2A%29%28%28If%5Bi%2B1%20%3C%3D%20max%2C%20v%5B%5Bi%2B1%2C%20j%5D%5D%2C%20%7B0.%2C0.%7D%5D%20%2B%20v%5B%5Bi%2C%20j%5D%5D%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29.%7B-1%2C0%7D%2C%0A%20%20%20%20%20%20v4%20%3D%20%20%28%2AFB%5B%2A%29%28%28If%5Bj-1%20%3E%3D%201%2C%20v%5B%5Bi%2C%20j-1%5D%5D%2C%20%7B0.%2C0.%7D%5D%20%2B%20v%5B%5Bi%2C%20j%5D%5D%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29.%7B0%2C1%7D%2C%0A%20%20%20%20%20%20org%20%3D%20u%5B%5Bi%2Cj%5D%5D%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20%20%20org%20%2B%20%20%28%0A%20%20%20%20%20%20%20%20%28%2ABB%5B%2A%29%28%2A%20here%20we%20add%20a%20lot%20of%20manual%20check%20for%20boundary%20condition%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20v1%20%28%2ABB%5B%2A%29%28If%5Bv1%20%3E0%2C%20If%5Bi-1%20%3E%3D%201%2C%20u%5B%5Bi-1%2C%20j%5D%5D%2C%20%7B0.%2C0.%7D%20%5D%2C%20org%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeB5AILqnMSXXKr0hjgskHleakFnMBGU6JydnpRfmleSlpzDDlQe5Ozvk5%2BUVFDGDwwR6dwcAAAAHdFiw%3D%22%2A%29%28%2A%5DBB%2A%29%20%20%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2B%20v3%20%28%2ABB%5B%2A%29%28If%5Bv3%3E0%2CIf%5Bi%2B1%20%3C%3D%20max%2C%20u%5B%5Bi%2B1%2C%20j%5D%5D%2C%20%7B0.%2C0.%7D%20%5D%2C%20org%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeB5AILqnMSXXKr0hjgskHleakFnMBGU6JydnpRfmleSlpzDDlQe5Ozvk5%2BUVFDGDwwR6dwcAAAAHdFiw%3D%22%2A%29%28%2A%5DBB%2A%29%2B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20v4%20If%5Bv4%20%3E0%2C%20If%5Bj-1%20%3E%3D%201%2C%20u%5B%5Bi%2C%20j-1%5D%5D%2C%20%7B0.%2C0.%7D%20%5D%2C%20org%5D%20%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2B%20v2%20If%5Bv2%3E0%2C%20If%5Bj%2B1%20%3C%3D%20max%2C%20u%5B%5Bi%2C%20j%2B1%5D%5D%2C%20%7B0.%2C0.%7D%20%5D%2C%20org%5D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%29%20%CE%B4t%20%0A%20%20%20%20%5D%0A%20%20%20%20%0A%20%20%2C%20%7Bi%2C%20max%7D%2C%20%7Bj%2C%20max%7D%5D%20%2F%2F%20Chop%0A%20%5D%5D%5D%3B%0A%0AremoveDivergence%20%3D%20Compile%5B%7B%7Bgrid%2C%20_Real%2C%203%7D%7D%2C%20With%5B%7B%0A%20%20max%20%3D%20grid%20%2F%2F%20Length%0A%7D%2C%0A%20%20MapIndexed%5BFunction%5B%7Bval%2C%20i%7D%2C%20%0A%20%20%20%20val%20%2B%20%28%2AFB%5B%2A%29%28%281%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%288.0%29%29%28%2A%5DFB%2A%29%20%28%0A%20%20%20%20%20%20%28%0A%20%20%20%20%20%20%20%20%28%0A%20%20%20%20%20%20%20%20%20%20%28%2ABB%5B%2A%29%28%2A%20here%20we%20add%20a%20lot%20of%20manual%20check%20for%20boundary%20condition%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20%20%20%20%20%20%20If%5Bi%5B%5B1%5D%5D%20-%201%20%3E%3D%201%20%26%26%20i%5B%5B1%5D%5D%20-%201%20%3C%3D%20max%20%26%26%20i%5B%5B2%5D%5D%20-%201%20%3E%3D%201%20%26%26%20i%5B%5B2%5D%5D%20-%201%20%3C%3D%20max%2C%20grid%5B%5Bi%5B%5B1%5D%5D%20-%201%2C%20i%5B%5B2%5D%5D%20-%201%5D%5D%2C%20%7B0.%2C0.%7D%5D%20%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%2B%20If%5Bi%5B%5B1%5D%5D%20%2B%201%20%3E%3D1%20%26%26%20i%5B%5B1%5D%5D%20%2B%201%20%3C%3D%20max%20%26%26%20i%5B%5B2%5D%5D%20%2B%201%20%3E%3D%201%20%26%26%20i%5B%5B2%5D%5D%20%2B%201%20%3C%3D%20max%2C%20grid%5B%5Bi%5B%5B1%5D%5D%20%2B%201%2C%20i%5B%5B2%5D%5D%20%2B%201%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%29.%7B1%2C1%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%29%7B1%2C1%7D%20%2B%0A%0A%20%20%20%20%20%20%28%0A%20%20%20%20%20%20%20%20%28%0A%20%20%20%20%20%20%20%20%20%20%28%2ABB%5B%2A%29%28%2A%20here%20we%20add%20a%20lot%20of%20manual%20check%20for%20boundary%20condition%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20%20%20%20%20%20%20If%5Bi%5B%5B1%5D%5D%20-%201%20%3E%3D%201%20%26%26%20i%5B%5B1%5D%5D%20-%201%20%3C%3D%20max%20%26%26%20i%5B%5B2%5D%5D%20%2B%201%20%3E%3D%201%20%26%26%20i%5B%5B2%5D%5D%20%2B%201%20%3C%3D%20max%2C%20grid%5B%5Bi%5B%5B1%5D%5D%20-%201%2C%20i%5B%5B2%5D%5D%20%2B%201%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%2B%20If%5Bi%5B%5B1%5D%5D%20%2B%201%20%3E%3D%201%20%26%26%20i%5B%5B1%5D%5D%20%2B%201%20%3C%3D%20max%20%26%26%20i%5B%5B2%5D%5D%20-%201%20%3E%3D%201%20%26%26%20i%5B%5B2%5D%5D%20-%201%20%3C%3D%20max%2C%20grid%5B%5Bi%5B%5B1%5D%5D%20%2B%201%2C%20i%5B%5B2%5D%5D%20-%201%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%29.%7B1%2C-1%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%29%7B1%2C-1%7D%20%2B%0A%0A%20%20%20%20%20%20%28%0A%20%20%20%20%20%20%20%20%28%2ABB%5B%2A%29%28If%5Bi%5B%5B1%5D%5D-1%20%3E%3D%201%20%26%26%20i%5B%5B1%5D%5D-1%20%3C%3D%20max%2C%20grid%5B%5Bi%5B%5B1%5D%5D-1%2C%20i%5B%5B2%5D%5D%20%5D%5D%2C%20%7B0.%2C0.%7D%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRAeB5AILqnMSXXKr0hjgskHleakFnMBGU6JydnpRfmleSlpzDDlQe5Ozvk5%2BUVFDGDwwR6dwcAAAAHdFiw%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2B%20If%5Bi%5B%5B1%5D%5D%2B1%20%3E%3D%201%20%26%26%20i%5B%5B1%5D%5D%2B1%20%3C%3D%20max%2C%20grid%5B%5B%20i%5B%5B1%5D%5D%2B1%2C%20i%5B%5B2%5D%5D%20%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20-%20If%5Bi%5B%5B2%5D%5D-1%20%3E%3D%201%20%26%26%20i%5B%5B2%5D%5D-1%20%3C%3D%20max%2C%20grid%5B%5B%20i%5B%5B1%5D%5D%2C%20i%5B%5B2%5D%5D-1%20%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20-%20If%5Bi%5B%5B2%5D%5D%2B1%20%3E%3D%201%20%26%26%20i%5B%5B2%5D%5D%2B1%20%3C%3D%20max%2C%20grid%5B%5Bi%5B%5B1%5D%5D%2C%20i%5B%5B2%5D%5D%2B1%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%29%7B2%2C-2%7D%20%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2B%20grid%5B%5B%20i%5B%5B1%5D%5D%2C%20i%5B%5B2%5D%5D%20%5D%5D%20%28-4%29%0A%0A%20%20%20%20%29%0A%20%20%5D%2C%20grid%2C%20%7B2%7D%5D%0A%5D%5D%3B%0A%0AbilinearInterpolation%20%3D%20Compile%5B%7B%7Barray%2C%20_Real%2C%203%7D%2C%20%7Bv%2C%20_Real%2C%201%7D%7D%2C%20%0A%28%2ABB%5B%2A%29%28%2A%20no%20big%20changes%20here%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0AModule%5B%0A%20%20%7Brows%2C%20cols%2C%20x%20%3D%20v%5B%5B2%5D%5D%2C%20y%20%3D%20v%5B%5B1%5D%5D%2C%20x1%2C%20x2%2C%20y1%2C%20y2%2C%20fQ11%2C%20fQ12%2C%20fQ21%2C%20fQ22%7D%2C%0A%20%20%0A%20%20%28%2A%20Get%20the%20dimensions%20of%20the%20array%20%2A%29%0A%20%20%7Brows%2C%20cols%7D%20%3D%20%7BLength%5Barray%5D%2C%20Length%5Barray%5D%7D%3B%0A%20%20%0A%20%20%28%2A%20Clip%20points%20to%20the%20boundaries%20%2A%29%0A%20%20x%20%3D%20Clip%5Bx%2C%20%7B1%2C%20cols%7D%5D%3B%0A%20%20y%20%3D%20Clip%5By%2C%20%7B1%2C%20rows%7D%5D%3B%0A%20%20%0A%20%20%28%2A%20Find%20the%20bounding%20indices%20%2A%29%0A%20%20x1%20%3D%20Floor%5Bx%5D%3B%20%0A%20%20x2%20%3D%20Ceiling%5Bx%5D%3B%0A%20%20y1%20%3D%20Floor%5By%5D%3B%20%0A%20%20y2%20%3D%20Ceiling%5By%5D%3B%0A%20%20%0A%20%20%28%2A%20Get%20the%20values%20at%20the%20four%20corners%20%2A%29%0A%20%20fQ11%20%3D%20array%5B%5By1%2C%20x1%5D%5D%3B%0A%20%20fQ12%20%3D%20array%5B%5By2%2C%20x1%5D%5D%3B%0A%20%20fQ21%20%3D%20array%5B%5By1%2C%20x2%5D%5D%3B%0A%20%20fQ22%20%3D%20array%5B%5By2%2C%20x2%5D%5D%3B%0A%20%20%0A%20%20%28%2A%20Perform%20bilinear%20interpolation%20%2A%29%0A%20%20If%5Bx2%20%3D%3D%20x1%2C%0A%20%20%20%20If%5By2%20%3D%3D%20y1%2C%0A%20%20%20%20%20%20fQ11%2C%0A%20%20%20%20%20%201%2F%282%20%28y2%20-%20y1%29%29%20%2A%20%28%0A%20%20%20%20%20%20%20%20fQ11%20%28y2%20-%20y%29%20%2B%0A%20%20%20%20%20%20%20%20fQ21%20%28y2%20-%20y%29%20%2B%0A%20%20%20%20%20%20%20%20fQ12%20%28y%20-%20y1%29%20%2B%0A%20%20%20%20%20%20%20%20fQ22%20%28y%20-%20y1%29%0A%20%20%20%20%20%20%29%0A%20%20%20%20%5D%2C%0A%20%20%20%20If%5By2%20%3D%3D%20y1%2C%0A%20%20%20%20%20%201%2F%282%20%28x2%20-%20x1%29%29%20%2A%20%28%0A%20%20%20%20%20%20%20%20fQ11%20%28x2%20-%20x%29%20%2B%0A%20%20%20%20%20%20%20%20fQ21%20%28x%20-%20x1%29%20%2B%0A%20%20%20%20%20%20%20%20fQ12%20%28x2%20-%20x%29%20%2B%0A%20%20%20%20%20%20%20%20fQ22%20%28x%20-%20x1%29%0A%20%20%20%20%20%20%29%2C%0A%20%20%20%20%20%201%2F%28%28x2%20-%20x1%29%20%28y2%20-%20y1%29%29%20%2A%20%28%0A%20%20%20%20%20%20%20%20fQ11%20%28x2%20-%20x%29%20%28y2%20-%20y%29%20%2B%0A%20%20%20%20%20%20%20%20fQ21%20%28x%20-%20x1%29%20%28y2%20-%20y%29%20%2B%0A%20%20%20%20%20%20%20%20fQ12%20%28x2%20-%20x%29%20%28y%20-%20y1%29%20%2B%0A%20%20%20%20%20%20%20%20fQ22%20%28x%20-%20x1%29%20%28y%20-%20y1%29%0A%20%20%20%20%20%20%29%0A%20%20%20%20%5D%0A%20%20%5D%0A%5D%5D%3B%20%20%20%20`}</WLJSEditor>

Let us test it again!

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"16b21fa2-abb0-4b08-915e-d00f25347ec6"} type={"Input"} opts={{}} >{`runTest%5B%22Compiled%22%5D`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"ecbfb280-ec3c-4653-8c47-9f1b4fb63496"} type={"Output"} opts={{}} >{`%28%2AGB%5B%2A%29%7B%7B%28%2ABB%5B%2A%29%28%22Compiled%22%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNiYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCRYg4ZGfkwJRxgkkgkuKMvPSnfIritmAPM%2BSxJzM5EweIBOiBKQhqDQnNZgNrhYsFlJUmgoAykcZ4w%3D%3D%22%2A%29%28%2A%5DBB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28FrontEndRef%5B%22695430be-0583-497f-8116-2c88bdb6b06d%22%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRCeEJBwK8rPK3HNS3GtSE0uLUlMykkNVgEKm1mamhgbJKXqGphaGOuaWJqn6VoYGprpGiVbWCSlJJklGZilAAByCRUe%22%2A%29%28%2A%5DVB%2A%29%7D%7D%28%2A%5DGB%2A%29`}</WLJSEditor>

<WLJSHTML>{`%3Cspan%20style%3D%22color%3Ared%22%3E%3Cb%20%3Ex5%3C%2Fb%3E%20time%20faster%3C%2Fspan%3E`}</WLJSHTML>

However, one should note, that this is still not a machine code, but rather byte-code of Wolfram Kernel internal command representation or something similar to that.

One can go futher and force WL to compile it to C and then link automatically. __This will probably require to have `gcc` or `clang` installed on your system__

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"9da84e82-862e-4190-9ad7-6d18bf5fc82b"} type={"Input"} opts={{"InitGroup":true,"Fade":true}} >{`advect%20%3D%20Compile%5B%7B%7Bv%2C%20_Real%2C%203%7D%2C%20%7Bu%2C%20_Real%2C%203%7D%2C%20%7B%CE%B4t%2C%20_Real%2C%200%7D%7D%20%2C%20With%5B%7Bmax%20%3D%20Length%5Bv%5D%7D%2C%20With%5B%7B%0A%20%0A%7D%2C%0A%20%20Table%5B%20%0A%20%20%0A%20%20%20%20With%5B%7B%0A%20%20%20%20%20%20v1%20%3D%20%20%28%2AFB%5B%2A%29%28%28If%5Bi-1%20%3E%3D%201%2C%20v%5B%5Bi-1%2C%20j%5D%5D%2C%20%7B0.%2C0.%7D%5D%20%2B%20v%5B%5Bi%2C%20j%5D%5D%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29.%7B1%2C0%7D%2C%0A%20%20%20%20%20%20v2%20%3D%20%20%28%2AFB%5B%2A%29%28%28If%5Bj%2B1%20%3C%3D%20max%2C%20v%5B%5Bi%2C%20j%2B1%5D%5D%2C%20%7B0.%2C0.%7D%5D%20%2B%20v%5B%5Bi%2C%20j%5D%5D%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29.%7B0%2C-1%7D%2C%0A%20%20%20%20%20%20v3%20%3D%20%20%28%2AFB%5B%2A%29%28%28If%5Bi%2B1%20%3C%3D%20max%2C%20v%5B%5Bi%2B1%2C%20j%5D%5D%2C%20%7B0.%2C0.%7D%5D%20%2B%20v%5B%5Bi%2C%20j%5D%5D%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29.%7B-1%2C0%7D%2C%0A%20%20%20%20%20%20v4%20%3D%20%20%28%2AFB%5B%2A%29%28%28If%5Bj-1%20%3E%3D%201%2C%20v%5B%5Bi%2C%20j-1%5D%5D%2C%20%7B0.%2C0.%7D%5D%20%2B%20v%5B%5Bi%2C%20j%5D%5D%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29.%7B0%2C1%7D%2C%0A%20%20%20%20%20%20org%20%3D%20u%5B%5Bi%2Cj%5D%5D%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20%20%20org%20%2B%20%20%28%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20v1%20If%5Bv1%20%3E0%2C%20If%5Bi-1%20%3E%3D%201%2C%20u%5B%5Bi-1%2C%20j%5D%5D%2C%20%7B0.%2C0.%7D%20%5D%2C%20org%5D%20%20%2B%20v3%20If%5Bv3%3E0%2CIf%5Bi%2B1%20%3C%3D%20max%2C%20u%5B%5Bi%2B1%2C%20j%5D%5D%2C%20%7B0.%2C0.%7D%20%5D%2C%20org%5D%2B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20v4%20If%5Bv4%20%3E0%2C%20If%5Bj-1%20%3E%3D%201%2C%20u%5B%5Bi%2C%20j-1%5D%5D%2C%20%7B0.%2C0.%7D%20%5D%2C%20org%5D%20%2B%20v2%20If%5Bv2%3E0%2C%20If%5Bj%2B1%20%3C%3D%20max%2C%20u%5B%5Bi%2C%20j%2B1%5D%5D%2C%20%7B0.%2C0.%7D%20%5D%2C%20org%5D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%29%20%CE%B4t%20%0A%20%20%20%20%5D%0A%20%20%20%20%0A%20%20%2C%20%7Bi%2C%20max%7D%2C%20%7Bj%2C%20max%7D%5D%20%2F%2F%20Chop%0A%20%5D%5D%20%2C%20CompilationOptions%20-%3E%20%7B%22InlineExternalDefinitions%22%20-%3E%20True%7D%2C%20%0A%20%20%20%20%22CompilationTarget%22%20-%3E%20%22C%22%2C%20%22RuntimeOptions%22%20-%3E%20%22Speed%22%5D%3B%0A%0AremoveDivergence%20%3D%20Compile%5B%7B%7Bgrid%2C%20_Real%2C%203%7D%7D%2C%20With%5B%7B%0A%20%20max%20%3D%20grid%20%2F%2F%20Length%0A%7D%2C%0A%20%20MapIndexed%5BFunction%5B%7Bval%2C%20i%7D%2C%20%0A%20%20%20%20val%20%2B%20%28%2AFB%5B%2A%29%28%281%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%288.0%29%29%28%2A%5DFB%2A%29%20%28%0A%20%20%20%20%20%20%28%0A%20%20%20%20%20%20%20%20%28%0A%20%20%20%20%20%20%20%20%20%20If%5Bi%5B%5B1%5D%5D%20-%201%20%3E%3D%201%20%26%26%20i%5B%5B1%5D%5D%20-%201%20%3C%3D%20max%20%26%26%20i%5B%5B2%5D%5D%20-%201%20%3E%3D%201%20%26%26%20i%5B%5B2%5D%5D%20-%201%20%3C%3D%20max%2C%20grid%5B%5Bi%5B%5B1%5D%5D%20-%201%2C%20i%5B%5B2%5D%5D%20-%201%5D%5D%2C%20%7B0.%2C0.%7D%5D%20%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%2B%20If%5Bi%5B%5B1%5D%5D%20%2B%201%20%3E%3D1%20%26%26%20i%5B%5B1%5D%5D%20%2B%201%20%3C%3D%20max%20%26%26%20i%5B%5B2%5D%5D%20%2B%201%20%3E%3D%201%20%26%26%20i%5B%5B2%5D%5D%20%2B%201%20%3C%3D%20max%2C%20grid%5B%5Bi%5B%5B1%5D%5D%20%2B%201%2C%20i%5B%5B2%5D%5D%20%2B%201%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%29.%7B1%2C1%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%29%7B1%2C1%7D%20%2B%0A%0A%20%20%20%20%20%20%28%0A%20%20%20%20%20%20%20%20%28%0A%20%20%20%20%20%20%20%20%20%20If%5Bi%5B%5B1%5D%5D%20-%201%20%3E%3D%201%20%26%26%20i%5B%5B1%5D%5D%20-%201%20%3C%3D%20max%20%26%26%20i%5B%5B2%5D%5D%20%2B%201%20%3E%3D%201%20%26%26%20i%5B%5B2%5D%5D%20%2B%201%20%3C%3D%20max%2C%20grid%5B%5Bi%5B%5B1%5D%5D%20-%201%2C%20i%5B%5B2%5D%5D%20%2B%201%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%2B%20If%5Bi%5B%5B1%5D%5D%20%2B%201%20%3E%3D%201%20%26%26%20i%5B%5B1%5D%5D%20%2B%201%20%3C%3D%20max%20%26%26%20i%5B%5B2%5D%5D%20-%201%20%3E%3D%201%20%26%26%20i%5B%5B2%5D%5D%20-%201%20%3C%3D%20max%2C%20grid%5B%5Bi%5B%5B1%5D%5D%20%2B%201%2C%20i%5B%5B2%5D%5D%20-%201%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%29.%7B1%2C-1%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%29%7B1%2C-1%7D%20%2B%0A%0A%20%20%20%20%20%20%28%0A%20%20%20%20%20%20%20%20If%5Bi%5B%5B1%5D%5D-1%20%3E%3D%201%20%26%26%20i%5B%5B1%5D%5D-1%20%3C%3D%20max%2C%20grid%5B%5Bi%5B%5B1%5D%5D-1%2C%20i%5B%5B2%5D%5D%20%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2B%20If%5Bi%5B%5B1%5D%5D%2B1%20%3E%3D%201%20%26%26%20i%5B%5B1%5D%5D%2B1%20%3C%3D%20max%2C%20grid%5B%5B%20i%5B%5B1%5D%5D%2B1%2C%20i%5B%5B2%5D%5D%20%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20-%20If%5Bi%5B%5B2%5D%5D-1%20%3E%3D%201%20%26%26%20i%5B%5B2%5D%5D-1%20%3C%3D%20max%2C%20grid%5B%5B%20i%5B%5B1%5D%5D%2C%20i%5B%5B2%5D%5D-1%20%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20-%20If%5Bi%5B%5B2%5D%5D%2B1%20%3E%3D%201%20%26%26%20i%5B%5B2%5D%5D%2B1%20%3C%3D%20max%2C%20grid%5B%5Bi%5B%5B1%5D%5D%2C%20i%5B%5B2%5D%5D%2B1%5D%5D%2C%20%7B0.%2C0.%7D%5D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%29%7B2%2C-2%7D%20%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2B%20grid%5B%5B%20i%5B%5B1%5D%5D%2C%20i%5B%5B2%5D%5D%20%5D%5D%20%28-4%29%0A%0A%20%20%20%20%29%0A%20%20%5D%2C%20grid%2C%20%7B2%7D%5D%0A%5D%2C%20CompilationOptions%20-%3E%20%7B%22InlineExternalDefinitions%22%20-%3E%20True%7D%2C%20%0A%20%20%20%20%22CompilationTarget%22%20-%3E%20%22C%22%2C%20%20%20%22RuntimeOptions%22%20-%3E%20%22Speed%22%5D%3B%0A%0A%0AbilinearInterpolation%20%3D%20Compile%5B%7B%7Barray%2C%20_Real%2C%203%7D%2C%20%7Bv%2C%20_Real%2C%201%7D%7D%2C%20Module%5B%0A%20%20%7Brows%2C%20cols%2C%20x%20%3D%20v%5B%5B2%5D%5D%2C%20y%20%3D%20v%5B%5B1%5D%5D%2C%20x1%2C%20x2%2C%20y1%2C%20y2%2C%20fQ11%2C%20fQ12%2C%20fQ21%2C%20fQ22%7D%2C%0A%20%20%0A%20%20%28%2A%20Get%20the%20dimensions%20of%20the%20array%20%2A%29%0A%20%20%7Brows%2C%20cols%7D%20%3D%20%7BLength%5Barray%5D%2C%20Length%5Barray%5D%7D%3B%0A%20%20%0A%20%20%28%2A%20Clip%20points%20to%20the%20boundaries%20%2A%29%0A%20%20x%20%3D%20Clip%5Bx%2C%20%7B1%2C%20cols%7D%5D%3B%0A%20%20y%20%3D%20Clip%5By%2C%20%7B1%2C%20rows%7D%5D%3B%0A%20%20%0A%20%20%28%2A%20Find%20the%20bounding%20indices%20%2A%29%0A%20%20x1%20%3D%20Floor%5Bx%5D%3B%20%0A%20%20x2%20%3D%20Ceiling%5Bx%5D%3B%0A%20%20y1%20%3D%20Floor%5By%5D%3B%20%0A%20%20y2%20%3D%20Ceiling%5By%5D%3B%0A%20%20%0A%20%20%28%2A%20Get%20the%20values%20at%20the%20four%20corners%20%2A%29%0A%20%20fQ11%20%3D%20array%5B%5By1%2C%20x1%5D%5D%3B%0A%20%20fQ12%20%3D%20array%5B%5By2%2C%20x1%5D%5D%3B%0A%20%20fQ21%20%3D%20array%5B%5By1%2C%20x2%5D%5D%3B%0A%20%20fQ22%20%3D%20array%5B%5By2%2C%20x2%5D%5D%3B%0A%20%20%0A%20%20%28%2A%20Perform%20bilinear%20interpolation%20%2A%29%0A%20%20If%5Bx2%20%3D%3D%20x1%2C%0A%20%20%20%20If%5By2%20%3D%3D%20y1%2C%0A%20%20%20%20%20%20fQ11%2C%0A%20%20%20%20%20%201%2F%282%20%28y2%20-%20y1%29%29%20%2A%20%28%0A%20%20%20%20%20%20%20%20fQ11%20%28y2%20-%20y%29%20%2B%0A%20%20%20%20%20%20%20%20fQ21%20%28y2%20-%20y%29%20%2B%0A%20%20%20%20%20%20%20%20fQ12%20%28y%20-%20y1%29%20%2B%0A%20%20%20%20%20%20%20%20fQ22%20%28y%20-%20y1%29%0A%20%20%20%20%20%20%29%0A%20%20%20%20%5D%2C%0A%20%20%20%20If%5By2%20%3D%3D%20y1%2C%0A%20%20%20%20%20%201%2F%282%20%28x2%20-%20x1%29%29%20%2A%20%28%0A%20%20%20%20%20%20%20%20fQ11%20%28x2%20-%20x%29%20%2B%0A%20%20%20%20%20%20%20%20fQ21%20%28x%20-%20x1%29%20%2B%0A%20%20%20%20%20%20%20%20fQ12%20%28x2%20-%20x%29%20%2B%0A%20%20%20%20%20%20%20%20fQ22%20%28x%20-%20x1%29%0A%20%20%20%20%20%20%29%2C%0A%20%20%20%20%20%201%2F%28%28x2%20-%20x1%29%20%28y2%20-%20y1%29%29%20%2A%20%28%0A%20%20%20%20%20%20%20%20fQ11%20%28x2%20-%20x%29%20%28y2%20-%20y%29%20%2B%0A%20%20%20%20%20%20%20%20fQ21%20%28x%20-%20x1%29%20%28y2%20-%20y%29%20%2B%0A%20%20%20%20%20%20%20%20fQ12%20%28x2%20-%20x%29%20%28y%20-%20y1%29%20%2B%0A%20%20%20%20%20%20%20%20fQ22%20%28x%20-%20x1%29%20%28y%20-%20y1%29%0A%20%20%20%20%20%20%29%0A%20%20%20%20%5D%0A%20%20%5D%0A%5D%20%2C%20CompilationOptions%20-%3E%20%7B%22InlineExternalDefinitions%22%20-%3E%20True%7D%2C%20%0A%20%20%20%20%22CompilationTarget%22%20-%3E%20%22C%22%2C%22RuntimeOptions%22%20-%3E%20%22Speed%22%5D%3B%20%20`}</WLJSEditor>

Now we have new results

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"4ae7a2ba-842d-4526-86a8-2961864ed5f1"} type={"Input"} opts={{}} >{`runTest%5B%22Compiled%20%2B%20C%22%5D`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"7a260453-994b-4ba2-a652-a0b41ff83253"} type={"Output"} opts={{}} >{`%28%2AGB%5B%2A%29%7B%7B%28%2ABB%5B%2A%29%28%22Compiled%20%2B%20C%22%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNiYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCRYg4ZGfkwJRxgkkgkuKMvPSnfIritmAPM%2BSxJzM5EweIBOiBKQhqDQnNZgNrhYsFlJUmgoAykcZ4w%3D%3D%22%2A%29%28%2A%5DBB%2A%29%7D%28%2A%7C%7C%2A%29%2C%28%2A%7C%7C%2A%29%7B%28%2AVB%5B%2A%29%28FrontEndRef%5B%2209dd1aaf-1abc-48e4-8407-2d04783abf9c%22%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRCeEJBwK8rPK3HNS3GtSE0uLUlMykkNVgEKG1impBgmJqbpGiYmJeuaWKSa6FqYGJjrGqUYmJhbGCcmpVkmAwCN5RX9%22%2A%29%28%2A%5DVB%2A%29%7D%7D%28%2A%5DGB%2A%29`}</WLJSEditor>

<WLJSHTML>{`%3Cspan%20style%3D%22color%3Ared%22%3E%3Cb%20%3Ex6%3C%2Fb%3E%20time%20faster%3C%2Fspan%3E`}</WLJSHTML>

We gained a bit of speed; we will see more difference once the grid is expanded and more iterations are needed.

## Immediate Graphics Mode
This only means, that we will do all rendering of our primitives by ourself. The graphics API will only display the rendered frame we crafted on Wolfram Kernel. The last also meant we migh have to transfer much more data over WebSockets to frontend.

Let me show you a simple example

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"6cf0317c-09c9-4e99-9515-ef4741b27d27"} type={"Input"} opts={{}} >{`Table%5BClip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B10%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%20%7Bx%2C-10%2C10%2C%200.5%7D%2C%20%7By%2C-10%2C10%2C%200.5%7D%5D%3B%0AImage%5B%25%2C%20Magnification%20-%3E%205%2C%20Antialiasing-%3EFalse%5D`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"9e248deb-85e1-4a1a-8d61-65efe29b1d70"} type={"Output"} opts={{}} >{`%28%2AVB%5B%2A%29%28FrontEndRef%5B%22a38a8802-948f-46d8-9f9a-33a0bf6828dd%22%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRCeEJBwK8rPK3HNS3GtSE0uLUlMykkNVgEKJxpbJFpYGBjpWppYpOmamKVY6FqmWSbqGhsnGiSlmVkYWaSkAAB9LBWL%22%2A%29%28%2A%5DVB%2A%29`}</WLJSEditor>

Here we used so-called SDF method for drawing graphics. We iterate over all posiitons of pixels in reactangle, produce brightness values and then send them to `Image`, which copies them into a texture on GPU.

We can use all 4 (RGBA) color channels to draw our picture

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"68edadf2-03e7-47c6-9ddb-fd75ee0ff1f7"} type={"Input"} opts={{}} >{`Table%5B%7B%0A%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B10%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%0A%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B5%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%0A%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B3%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%0A%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B1%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%0A%7D%2C%20%7Bx%2C-10%2C10%2C%200.5%7D%2C%20%7By%2C-10%2C10%2C%200.5%7D%5D%3B%0AImage%5B%25%2C%20Magnification%20-%3E%205%2C%20Antialiasing-%3EFalse%5D`}</WLJSEditor>

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"2a261f4b-bff3-4147-8281-d86eb9067f03"} type={"Input"} opts={{}} >{`%28%2AVB%5B%2A%29%28FrontEndRef%5B%2237dbfc31-9a78-43de-bb3d-a7828a5639f6%22%5D%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNkYGAoZgESHvk5KRCeEJBwK8rPK3HNS3GtSE0uLUlMykkNVgEKG5unJKUlGxvqWiaaW%2BiaGKek6iYlGafoAnlGFommZsaWaWYAjRsV4g%3D%3D%22%2A%29%28%2A%5DVB%2A%29`}</WLJSEditor>

__For the best performance__ use `NumericArray`, since it packs all numberic data to a more compact form

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"a6040353-179c-4fa6-aca7-9374b3a26514"} type={"Input"} opts={{}} >{`Table%5B%7B%0A%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B10%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%0A%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B5%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%0A%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B3%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%0A%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B1%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%0A%7D%2C%20%7Bx%2C-10%2C10%2C%200.5%7D%2C%20%7By%2C-10%2C10%2C%200.5%7D%5D%3B%0AImage%5BNumericArray%5B%25%2C%20%22Real32%22%5D%2C%20Magnification%20-%3E%205%2C%20Antialiasing-%3EFalse%5D`}</WLJSEditor>

---

### Dynamic image
There is a usual way on how to update our `Image` - using `Offload` technique as we did before

><WLJSHTML>{`%3Cb%20%3ETIP%3C%2Fb%3E`}</WLJSHTML>
Real values takes more time to deserialize on frontend, we will use `UnsignedInteger8`

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"6f7e3a9c-fdea-4f80-b7af-9152dc302506"} type={"Input"} opts={{}} >{`serialize%5Barr_List%5D%20%3A%3D%20NumericArray%5Barr%2C%20%22UnsignedInteger8%22%2C%20%22ClipAndRound%22%5D%3B%0A%0Abuffer%20%3D%20Table%5B255.0%20%7B%0A%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B10%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%0A%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B5%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%0A%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B3%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%0A%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5Bx%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5By%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B1%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%0A%7D%2C%20%7Bx%2C-10%2C10%2C%200.5%7D%2C%20%7By%2C-10%2C10%2C%200.5%7D%5D%20%2F%2F%20serialize%3B%0A%0AImage%5Bbuffer%20%2F%2F%20Offload%2C%20%22Byte%22%2C%20Magnification%20-%3E%205%2C%20Antialiasing-%3EFalse%5D`}</WLJSEditor>

![](./../eye-ezgif.com-optimize.gif)

Now we can easily update our image by setting new values to `buffer`

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"f8c2fc4f-f0a6-43e5-a137-c474d6a6a98d"} type={"Input"} opts={{}} >{`t%20%3A%3D%20AbsoluteTime%5B%5D%3B%0A%0Atask%20%3D%20SetInterval%5B%0A%20%20buffer%20%3D%20Table%5B255.0%20%7B%0A%20%20%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5B%28x%20%2B%20Cos%5Bt%5D%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5B%28y%20-%20Sin%5Bt%5D%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B3%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%0A%20%20%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5B%28x%20-%20Cos%5Bt%5D%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5B%28y%20-%20Sin%5Bt%5D%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B5%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%0A%20%20%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5B%28x%20%2B%20Cos%5Bt%5D%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5B%28y%20%2B%20Sin%5Bt%5D%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B10%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%2C%0A%20%20%20%20Clip%5B%28%28%2ASpB%5B%2A%29Power%5B%28x%20-%20Cos%5Bt%5D%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%20%2B%20%28%2ASpB%5B%2A%29Power%5B%28y%20%2B%20Sin%5Bt%5D%29%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%29%20-%20%28%2ASpB%5B%2A%29Power%5B1%28%2A%7C%2A%29%2C%28%2A%7C%2A%292%5D%28%2A%5DSpB%2A%29%2C%20%7B0%2C%201%7D%5D%0A%20%20%7D%2C%20%7Bx%2C-10%2C10%2C%200.5%7D%2C%20%7By%2C-10%2C10%2C%200.5%7D%5D%20%2F%2F%20serialize%3B%0A%2C%20100%5D%3B%0A%0ASetTimeout%5BTaskRemove%5Btask%5D%2C%2010000%5D%3B`}</WLJSEditor>

If you made that far, **congratulations** ‚≠êÔ∏è Now you have learned how to do the software rendering. 

> Please, never do *software rendering*. It is slow and basically is a waste of resources of your CPU, which was not designed for rendering graphics. Use it only for educational purposes, small images or complex calulations, which are not possible to do using GPU.

## Virtual Ink
To visualize velocity field, one can actually use another scalar field instead of 1000 probing balls. This scalar field is easy to imagine: ink ‚úçüèº or dye or goo, which fell into a water and now is carried by the steams of fluid

$$
\frac{\partial{u_{ink}}}{\partial{t}} + (\mathbf{v}\cdot \nabla) u_{ink} = 0
$$

We already know how to solve advection equation. Our function `advect` is used for modelling the momentum of fluid, which is a 2D vector field... Why not then to use __two kinds of ink__?

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"87b65963-4580-4c9f-a471-b67a3ac3ab47"} type={"Input"} opts={{"InitGroup":true}} >{`ink%20%3D%20Table%5B%7B0.%2C0.%7D%2C%20%7Bi%2C50%7D%2C%20%7Bj%2C50%7D%5D%3B%0A%0A%28%2ABB%5B%2A%29%28%2A%20transform%20to%20%22byte%22%20format%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0Anink%20%3D%20NumericArray%5BMap%5B255.0%20%7B%23%5B%5B1%5D%5D%2C%200.%2C%20%23%5B%5B2%5D%5D%7D%20%26%2C%20ink%2C%20%7B2%7D%5D%2C%20%22UnsignedInteger8%22%2C%20%22ClipAndRound%22%5D%3B`}</WLJSEditor>

Then we can directly visualize `nink` scalar field instead of drawing many many arrows and dots. In this way we will utilize fully our expensive software rendering.

__TL;DR__ Final program

<WLJSEditor display={"codemirror"} nid={"73fe49db-9a23-480c-b68c-e4e3334021f7"} id={"63d3faa1-b130-427a-b958-7f416cf688f1"} type={"Input"} opts={{}} >{`vgrid%20%3D%20Table%5B%7B0.%2C0.%7D%2C%20%7Bi%2C50%7D%2C%20%7Bj%2C50%7D%5D%3B%0A%0Aink%20%3D%200.%20ink%3B%0Anink%20%3D%20NumericArray%5BMap%5B255.0%20%7B%23%5B%5B1%5D%5D%2C%200.%2C%20%23%5B%5B2%5D%5D%7D%20%26%2C%20ink%2C%20%7B2%7D%5D%2C%20%22UnsignedInteger8%22%2C%20%22ClipAndRound%22%5D%3B%0A%0Adest%20%3D%20%7B0%2C0%7D%3B%0Acink%20%3D%20%7B1.0%2C0.2%7D%3B%0Avfps%20%3D%200%3B%0A%0AWith%5B%7B%0A%20%20win%20%3D%20CurrentWindow%5B%5D%2C%20%0A%20%20currentCell%20%3D%20ResultCell%5B%5D%0A%7D%2C%0A%0A%20%20EventHandler%5Bwin%2C%20%7B%22Closed%22%20-%3E%20Function%5BNull%2C%0A%20%20%20%20Delete%5BcurrentCell%5D%20%28%2ABB%5B%2A%29%28%2A%20remove%20output%20cell%20if%20a%20notebook%20has%20been%20closed%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20%28%2ABB%5B%2A%29%28%2A%20this%20will%20prevent%20the%20animation%20running%20uncontrollably%20on%20the%20next%20start%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%5D%7D%5D%3B%0A%0A%20%20Graphics%5B%7B%0A%0A%20%20%20%20%28%2ABB%5B%2A%29%28%2Aattach%20listeners%20to%20a%20user%27s%20mouse%20to%20manipulate%20the%20grid%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20EventHandler%5BGraphics%60Canvas%5B%5D%2C%20%7B%0A%20%20%20%20%20%20%22click%22%20-%3E%20Function%5BNull%2C%0A%20%20%20%20%20%20%20%20cink%20%3D%20cink%20%2F%2F%20Reverse%3B%0A%20%20%20%20%20%20%5D%2C%0A%0A%20%20%20%20%20%20%22mousemove%22%20-%3E%20Function%5Bpos%2C%20With%5B%7B%0A%20%20%20%20%20%20%20%20%20%20xy%20%3D%20%7B50.0%20-%20pos%5B%5B2%5D%5D%2C%20pos%5B%5B1%5D%5D%7D%0A%20%20%20%20%20%20%20%20%7D%2C%20%0A%20%20%20%20%20%20%20%20%20%20With%5B%7Bp%20%3D%20Round%5Bxy%5D%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20If%5Bp%5B%5B1%5D%5D%20%3C%3D%2050-1%20%26%26%20p%5B%5B1%5D%5D%20%3E%3D2%20%26%26%20p%5B%5B2%5D%5D%20%3C%3D50-1%20%26%26%20p%5B%5B2%5D%5D%20%3E%3D2%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%28%2ABB%5B%2A%29%28%2A%20accelerate%20the%20fluid%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vgrid%5B%5Bp%5B%5B1%5D%5D%2Cp%5B%5B2%5D%5D%5D%5D%20%3D%20Normalize%5B%28xy%20-%20dest%29%5D%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%28%2ABB%5B%2A%29%28%2A%20add%20some%20ink%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ink%5B%5Bp%5B%5B1%5D%5D%2Cp%5B%5B2%5D%5D%5D%5D%20%3D%20cink%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ink%5B%5Bp%5B%5B1%5D%5D%2B1%2Cp%5B%5B2%5D%5D%5D%5D%20%3D%20cink%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ink%5B%5Bp%5B%5B1%5D%5D-1%2Cp%5B%5B2%5D%5D%5D%5D%20%3D%20cink%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ink%5B%5Bp%5B%5B1%5D%5D%2Cp%5B%5B2%5D%5D%2B1%5D%5D%20%3D%20cink%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ink%5B%5Bp%5B%5B1%5D%5D%2Cp%5B%5B2%5D%5D%2B1%5D%5D%20%3D%20cink%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%5D%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20dest%20%3D%20xy%3B%0A%20%20%20%20%20%20%20%20%5D%20%5D%0A%20%20%20%20%7D%5D%2C%20%0A%0A%20%20%20%20%28%2ABB%5B%2A%29%28%2Async%20with%20browser%27s%20repaint%20cycle%20and%20update%20of%20fps%20label%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20AnimationFrameListener%5Bvfps%20%2F%2F%20Offload%2C%20%22Event%22-%3E%22vframe%22%5D%2C%20%0A%0A%20%20%20%20%28%2ABB%5B%2A%29%28%2Ainsert%20our%20Image%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20Inset%5B%0A%20%20%20%20%0A%20%20%20%20%20%20Image%5Bnink%20%2F%2F%20Offload%2C%20%22Byte%22%2C%20Magnification-%3E10%5D%0A%20%20%20%20%0A%20%20%20%20%2C%20%7B0%2C0%7D%2C%20%7B0%2C0%7D%2C%20%7B500%2C500%7D%2C%20%0A%20%20%20%20%0A%20%20%20%20%20%20%28%2ABB%5B%2A%29%28%2A%20do%20not%20apply%20any%20transformation.%20keep%20the%20original%20size%20%2A%29%28%2A%2C%2A%29%28%2A%221%3AeJxTTMoPSmNhYGAo5gcSAUX5ZZkpqSn%2BBSWZ%2BXnFaYwgCS4g4Zyfm5uaV%2BKUXxEMUqxsbm6exgSSBPGCSnNSg9mAjOCSosy8dLBYSFFpKpoKkDkeqYkpEFXBILO1sCgJSczMQVYCAOFrJEU%3D%22%2A%29%28%2A%5DBB%2A%29%0A%20%20%20%20%20%20ViewMatrix-%3ENone%0A%20%20%20%20%5D%2C%0A%20%20%20%20%0A%20%20%20%20Text%5Bvfps%20%2F%2F%20Offload%2C%20%7B0%2C0%7D%5D%0A%0A%20%20%20%20%0A%20%20%7D%2C%20%0A%20%20%20%20Controls-%3EFalse%2C%20%0A%20%20%20%20ImageSize-%3E500%2C%20%0A%20%20%20%20PlotRange-%3E%7B%7B0%2C50%7D%2C%20%7B0%2C50%7D%7D%2C%20%0A%20%20%20%20ImagePadding-%3ENone%0A%20%20%5D%0A%5D%0A%0A%28%2A%20subscribe%20to%20animation%20event%20%2A%29%0A%0Avtime%20%3D%20AbsoluteTime%5B%5D%3B%0A%0AEventHandler%5B%22vframe%22%2C%20Function%5BNull%2C%0A%20%20%0A%20%20vgrid%20%3D%20advect%5Bvgrid%2Cvgrid%2C%201.0%5D%3B%0A%20%20vgrid%20%3D%20removeDivergence%5Bvgrid%5D%3B%0A%20%20vgrid%20%3D%20removeDivergence%5Bvgrid%5D%3B%0A%0A%20%20ink%20%3D%20With%5B%7Ba%20%3D%20advect%5Bvgrid%2C%20ink%2C%201.0%5D%7D%2C%20advect%5Bvgrid%2C%20a%2C%201.0%5D%5D%3B%0A%20%20nink%20%3D%20NumericArray%5BMap%5B255.0%20%7B1.0%20-%20%23%5B%5B2%5D%5D%2C%201.0-%20%23%5B%5B1%5D%5D%2C%201.0%20-%20%23%5B%5B1%5D%5D%2C%201.0%7D%20%26%2C%20ink%2C%20%7B2%7D%5D%2C%20%22UnsignedInteger8%22%2C%20%22ClipAndRound%22%5D%3B%0A%20%20%0A%20%20vfps%20%3D%20%28%2AFB%5B%2A%29%28%28%28vfps%20%2B%201%20%2F%20%28AbsoluteTime%5B%5D%20-%20vtime%29%29%29%28%2A%2C%2A%29%2F%28%2A%2C%2A%29%282.0%29%29%28%2A%5DFB%2A%29%20%2F%2F%20Round%3B%0A%20%20vtime%20%3D%20AbsoluteTime%5B%5D%3B%20%0A%5D%5D%3B`}</WLJSEditor>

We do here pretty much the same as before; however, there are no longer arrows but a single `Inset` with a raster dynamic image inside. This places the `Image` on top of our `Graphics` canvas. This overlay is helpful since we can still listen to mouse positions and display FPS at a low cost. The fluid goes in the same direction as the mouse

import testVideo from './attachments/fluid_raster.mov';

<video width={"100%"} controls>
  <source src={testVideo}/>
</video>

I (Me - @JerryI) personally believe that we pushed the implementation to the limits of this toy model running on a CPU with an interpretive programming language. The next step definitely should be to utilize GPU compute shaders such as WebGPU, OpenCL, CUDA to calculate bigger fields and pipe the data directly to the canvas. However, this will be another story.

Thank you ‚ù§Ô∏è