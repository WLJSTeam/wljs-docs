"use strict";(self.webpackChunkwlx_docs=self.webpackChunkwlx_docs||[]).push([[56614],{7368:(t,e,n)=>{n.d(e,{A:()=>i});const i=n.p+"assets/images/step3-ezgif.com-video-to-gif-converter-a2da2a7b5655abd89fa381808c0d822e.gif"},9234:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>c,contentTitle:()=>r,default:()=>b,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var i=n(74848),s=n(28453);const a={},r=void 0,o={id:"frontend/Advanced/Dynamics/Porting from MMA/Animation",title:"Animation",description:"In this section we will learn step by step how to run (and port possibly) and optimize animation code from Wolfram Mathematica to WLJS.",source:"@site/docs/frontend/Advanced/Dynamics/Porting from MMA/Animation.md",sourceDirName:"frontend/Advanced/Dynamics/Porting from MMA",slug:"/frontend/Advanced/Dynamics/Porting from MMA/Animation",permalink:"/frontend/Advanced/Dynamics/Porting from MMA/Animation",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Porting from MMA",permalink:"/frontend/Advanced/Dynamics/Porting from MMA/"},next:{title:"Prototyping",permalink:"/frontend/Advanced/Dynamics/Prototyping"}},c={},l=[{value:"Optimization",id:"optimization",level:2},{value:"Step 0",id:"step-0",level:3},{value:"Step 1",id:"step-1",level:3},{value:"Step 3",id:"step-3",level:3}];function S(t){const e={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...t.components},{CodeMirror:a,Details:r}=e;return a||d("CodeMirror",!0),r||d("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.p,{children:"In this section we will learn step by step how to run (and port possibly) and optimize animation code from Wolfram Mathematica to WLJS."}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsxs)(e.p,{children:["An example by Peter Tenisheff (",(0,i.jsx)(e.a,{href:"mailto:tenishefff@yandex.ru",children:"tenishefff@yandex.ru"}),")"]}),"\n"]}),"\n",(0,i.jsxs)(e.p,{children:["Here is an original Wolfram Mathematica code of a ",(0,i.jsx)(e.em,{children:"triple pendulum"}),":"]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.em,{children:"Initialization of variables, equations"})}),"\n",(0,i.jsx)(r,{children:(0,i.jsx)(a,{children:"ClearAll[g, m, l, timeMax, [Theta]1, [Theta]2, [Theta]3];\n\ng = 9.81;\n(*SbB[*)Subscript[m(*|*),(*|*)1](*]SbB*) = 1; (*SbB[*)Subscript[m(*|*),(*|*)2](*]SbB*) = 1; (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*) = 1;\n(*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*) = 1; (*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*) = 1; (*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*) = 1;\ntimeMax = 10;\n\n\neqns = {\n  ((*SbB[*)Subscript[m(*|*),(*|*)1](*]SbB*) + (*SbB[*)Subscript[m(*|*),(*|*)2](*]SbB*) + (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*)) (*SpB[*)Power[(*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*)(*|*),(*|*)2](*]SpB*) [Theta]1''[t] + ((*SbB[*)Subscript[m(*|*),(*|*)2](*]SbB*) + (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*)) (*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*) [Theta]2''[t] Cos[[Theta]1[t] - [Theta]2[t]] +\n  (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*) [Theta]3''[t] Cos[[Theta]1[t] - [Theta]3[t]] +\n  ((*SbB[*)Subscript[m(*|*),(*|*)2](*]SbB*) + (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*)) (*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*) (*SpB[*)Power[[Theta]2'[t](*|*),(*|*)2](*]SpB*) Sin[[Theta]1[t] - [Theta]2[t]] +\n  (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*) (*SpB[*)Power[[Theta]3'[t](*|*),(*|*)2](*]SpB*) Sin[[Theta]1[t] - [Theta]3[t]] +\n  g ((*SbB[*)Subscript[m(*|*),(*|*)1](*]SbB*) + (*SbB[*)Subscript[m(*|*),(*|*)2](*]SbB*) + (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*)) (*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*) Sin[[Theta]1[t]] == 0,\n  \n  ((*SbB[*)Subscript[m(*|*),(*|*)2](*]SbB*) + (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*)) (*SpB[*)Power[(*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*)(*|*),(*|*)2](*]SpB*) [Theta]2''[t] + ((*SbB[*)Subscript[m(*|*),(*|*)2](*]SbB*) + (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*)) (*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*) [Theta]1''[t] Cos[[Theta]1[t] - [Theta]2[t]] +\n  (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*) [Theta]3''[t] Cos[[Theta]2[t] - [Theta]3[t]] -\n  ((*SbB[*)Subscript[m(*|*),(*|*)2](*]SbB*) + (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*)) (*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*) [Theta]1'[t]^2 Sin[[Theta]1[t] - [Theta]2[t]] +\n  (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*) (*SpB[*)Power[[Theta]3'[t](*|*),(*|*)2](*]SpB*) Sin[[Theta]2[t] - [Theta]3[t]] +\n  g ((*SbB[*)Subscript[m(*|*),(*|*)2](*]SbB*) + (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*)) (*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*) Sin[[Theta]2[t]] == 0,\n\n  (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*) (*SpB[*)Power[(*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*)(*|*),(*|*)2](*]SpB*) [Theta]3''[t] + (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*) [Theta]1''[t] Cos[[Theta]1[t] - [Theta]3[t]] +\n  (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*) [Theta]2''[t] Cos[[Theta]2[t] - [Theta]3[t]] -\n  (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*) (*SpB[*)Power[[Theta]1'[t](*|*),(*|*)2](*]SpB*) Sin[[Theta]1[t] - [Theta]3[t]] -\n  (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*) (*SpB[*)Power[[Theta]2'[t](*|*),(*|*)2](*]SpB*) Sin[[Theta]2[t] - [Theta]3[t]] +\n  g (*SbB[*)Subscript[m(*|*),(*|*)3](*]SbB*) (*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*) Sin[[Theta]3[t]] == 0\n};\n\ninitCond = {\n  [Theta]1[0] == (*FB[*)(([Pi])(*,*)/(*,*)(2))(*]FB*) - 0.1,\n  [Theta]2[0] == [Pi],\n  [Theta]3[0] == [Pi],\n  [Theta]1'[0] == 0,\n  [Theta]2'[0] == 0,\n  [Theta]3'[0] == 0\n};\n\nsol = NDSolve[{eqns, initCond}, {[Theta]1, [Theta]2, [Theta]3}, {t, 0, timeMax}] // First;\n  \nClearAll[xC, yC];\n\nWith[{\n  [Phi]1 = [Theta]1 /. sol,\n  [Phi]2 = [Theta]2 /. sol,\n  [Phi]3 = [Theta]3 /. sol\n},\n\n  xC[t_, 1] := (*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*) Sin[[Phi]1[t]];\n  yC[t_, 1] := -(*SbB[*)Subscript[l(*|*),(*|*)1](*]SbB*) Cos[[Phi]1[t]];\n  xC[t_, 2] := xC[t, 1] + (*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*) Sin[[Phi]2[t]];\n  yC[t_, 2] := yC[t, 1] - (*SbB[*)Subscript[l(*|*),(*|*)2](*]SbB*) Cos[[Phi]2[t]];\n  xC[t_, 3] := xC[t, 2] + (*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*) Sin[[Phi]3[t]];\n  yC[t_, 3] := yC[t, 2] - (*SbB[*)Subscript[l(*|*),(*|*)3](*]SbB*) Cos[[Phi]3[t]];\n\n];\n\ntrajectory = Table[{xC[t, 3], yC[t, 3]}, {t, 0, timeMax, 0.05}];"})}),"\n",(0,i.jsx)(e.h2,{id:"optimization",children:"Optimization"}),"\n",(0,i.jsx)(e.h3,{id:"step-0",children:"Step 0"}),"\n",(0,i.jsx)(e.p,{children:"Let's run Mathematica's code for animation directly:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-mathematica",children:"Animate[\n    Graphics[\n      {\n        Thick, Black,\n        Line[{{0, 0}, {xC[t, 1], yC[t, 1]}, {xC[t, 2], yC[t, 2]}, {xC[t, 3], yC[t, 3]}}],\n        \n        Blue, PointSize[0.03], Point[{xC[t, 1], yC[t, 1]}],\n        Red, PointSize[0.03], Point[{xC[t, 2], yC[t, 2]}],\n        Black, PointSize[0.04], Point[{xC[t, 3], yC[t, 3]}],\n        \n        {Green, Opacity[0.5], Line[trajectory[[;; Floor[t/0.05] + 1]]]}\n      },\n      PlotRange -> {{-3.5, 3.5}, {-3.5, 0.5}},\n      Axes -> True,\n      Background -> White,\n      ImageSize -> 500\n    ],\n    {t, 0, timeMax, 0.05},\n    AnimationRate -> 5\n]\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:n(79654).A+"",width:"800",height:"784"})}),"\n",(0,i.jsx)(e.p,{children:"It is slow and shakes, but it works. Here is why:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["each frame a new ",(0,i.jsx)(e.code,{children:"Graphics"})," object is created and copied to the frontend and then evaluated \u274c"]}),"\n",(0,i.jsx)(e.li,{children:"each frame creates a new instanced and destroys an old one \u274c"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"This is a huge waste of resources considering that we only need to change a few points and line segments."}),"\n",(0,i.jsx)(e.h3,{id:"step-1",children:"Step 1"}),"\n",(0,i.jsx)(e.p,{children:"As a first step we find what primitives we need to change each frame:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"Point"})," x3"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"Line"})," x2 (one for pendulum segments and one for trajectory)"]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"Then we can image:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-mathematica",children:"{\n\t...,\n\tRed, Point[pt1 // Offload],\n\tBlue, Point[pt2 // Offload], \n\t...\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"or even better - reduce the number of symbols used:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-mathematica",children:"{\n\t...,\n\tLine[{{0,0}, pts[[1]], pts[[2]], pts[[3]]} // Offload],\n\tRed, Point[pts[[1]] // Offload],\n\tBlue, Point[pts[[2]] // Offload], \n\t...\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:["To prevent ",(0,i.jsx)(e.code,{children:"Animate"})," from reevaluation of the whole ",(0,i.jsx)(e.code,{children:"Graphics"})," expression we provide a custom ",(0,i.jsx)(e.code,{children:'"UpdateFunction"'}),", which overrides the default behavior and update only our ",(0,i.jsx)(e.code,{children:"pts"})," symbol:"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-mathematica",children:'Module[{pts, track},\n  Animate[\n    Graphics[\n      {\n        Thick, Black,\n        Line[{{0,0}, pts[[1]], pts[[2]], pts[[3]]} // Offload],\n        \n        Blue, PointSize[0.03], Point[pts[[1]] // Offload],\n        Red, PointSize[0.03], Point[pts[[2]] // Offload],\n        Black, PointSize[0.04], Point[pts[[3]] // Offload],\n        \n        {Green, Opacity[0.5], Line[track // Offload]}\n      },\n      PlotRange -> {{-3.5, 3.5}, {-3.5, 0.5}},\n      Axes -> True,\n      Background -> White,\n      ImageSize -> 500\n    ],\n    {t, 0, timeMax, 0.05},\n    "UpdateFunction" -> Function[t,\n      track = trajectory[[;; Floor[t/0.05] + 1]];\n      pts = Table[{xC[t, i], yC[t, i]}, {i,3}];\n      False\n    ],\n    AnimationRate -> 30\n  ]\n]\n'})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:n(87817).A+"",width:"800",height:"784"})}),"\n",(0,i.jsx)(e.p,{children:"Note, that we also increased a frame rate up-to 30. This works much smoother because:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"Graphics"})," expression stays and does not change \u2705"]}),"\n",(0,i.jsxs)(e.li,{children:["Only ",(0,i.jsx)(e.code,{children:"Line"})," and ",(0,i.jsx)(e.code,{children:"Point"})," are updated \u2705"]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"step-3",children:"Step 3"}),"\n",(0,i.jsxs)(e.p,{children:["You may noticed an odd-looking shaking of a trajectory on the background. It is a side-effect of interpolation enabled by the default on ",(0,i.jsx)(e.a,{href:"/frontend/Reference/Graphics/",children:"Graphics"}),". It makes all transitions even smoother (60 or 120 FPS), but cannot handle properly ",(0,i.jsx)(e.code,{children:"Line"})," with variable number of segments."]}),"\n",(0,i.jsx)(e.p,{children:"One can disable the transition animation completely by setting an option:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-mathematica",children:"Graphics[..., TransitionType -> None]\n"})}),"\n",(0,i.jsx)(e.p,{children:"This might give a performance boost in the case of a very fast animations (where the frame rate is close to 30)."}),"\n",(0,i.jsxs)(e.p,{children:["Another way is to disable it ",(0,i.jsx)(e.strong,{children:"only"})," for ",(0,i.jsx)(e.code,{children:"Line"})," primitive using ",(0,i.jsx)(e.code,{children:"Directive"}),":"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-mathematica",children:'Module[{pts, track},\n  Animate[\n    Graphics[\n      {\n        Thick, Black,\n        Line[{{0,0}, pts[[1]], pts[[2]], pts[[3]]} // Offload],\n        \n        Blue, PointSize[0.03], Point[pts[[1]] // Offload],\n        Red, PointSize[0.03], Point[pts[[2]] // Offload],\n        Black, PointSize[0.04], Point[pts[[3]] // Offload],\n        \n        {Green, Opacity[0.5], Directive[TransitionType->None], \n        Line[track // Offload]}\n      },\n      PlotRange -> {{-3.5, 3.5}, {-3.5, 0.5}},\n      Axes -> True,\n      Background -> White,\n      ImageSize -> 500\n    ],\n    {t, 0, timeMax, 0.05},\n    "UpdateFunction" -> Function[t,\n      track = trajectory[[;; Floor[t/0.05] + 1]];\n      pts = Table[{xC[t, i], yC[t, i]}, {i,3}];\n      False\n    ],\n    AnimationRate -> 30\n  ]\n]\n'})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:n(7368).A+"",width:"800",height:"784"})}),"\n",(0,i.jsx)(e.p,{children:"As a result:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Points and segments of a pendulum interpolated to get extra frames \u2705"}),"\n",(0,i.jsx)(e.li,{children:"Background trajectory line is updated as it is \u2705"}),"\n"]})]})}function b(t={}){const{wrapper:e}={...(0,s.R)(),...t.components};return e?(0,i.jsx)(e,{...t,children:(0,i.jsx)(S,{...t})}):S(t)}function d(t,e){throw new Error("Expected "+(e?"component":"object")+" `"+t+"` to be defined: you likely forgot to import, pass, or provide it.")}},28453:(t,e,n)=>{n.d(e,{R:()=>r,x:()=>o});var i=n(96540);const s={},a=i.createContext(s);function r(t){const e=i.useContext(a);return i.useMemo((function(){return"function"==typeof t?t(e):{...e,...t}}),[e,t])}function o(t){let e;return e=t.disableParentContext?"function"==typeof t.components?t.components(s):t.components||s:r(t.components),i.createElement(a.Provider,{value:e},t.children)}},79654:(t,e,n)=>{n.d(e,{A:()=>i});const i=n.p+"assets/images/original-ezgif.com-optimize-781a60cbca4534a81d51824283a42db7.gif"},87817:(t,e,n)=>{n.d(e,{A:()=>i});const i=n.p+"assets/images/step2-ezgif.com-optimize-bd2c9a456817374df05ac5618ee2d09d.gif"}}]);